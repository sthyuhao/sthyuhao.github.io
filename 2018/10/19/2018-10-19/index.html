<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="sthyuhao"><title>weakåˆ°åº•åšäº†äº›å•¥ï¼Ÿ Â· ä½™ç”Ÿ</title><meta name="description" content="weakåˆ°åº•åšäº†äº›å•¥ï¼Ÿå…¥è¡Œä¹Ÿå¥½å‡ å¹´äº†ï¼Œå…³äºå†…å­˜ç®¡ç†å‡ ä¹æ˜¯é¢è¯•ä¸­å¿…å®šä¼šé—®åˆ°çš„é—®é¢˜ï¼Œå†…å­˜ç®¡ç†ä¸­é—®çš„æœ€å¤šçš„å¤§æ¦‚å°±æ˜¯å¾ªç¯å¼•ç”¨å’Œweakçš„å®ç°äº†ï¼Œå…³äºweakæ€ä¹ˆå°†ä¿®é¥°çš„å¯¹è±¡ç½®ä¸ºnilçš„ï¼Œå¯èƒ½å‡ å¹´å‰çš„å›ç­”å°±æ˜¯ï¼š
1runtimeç»´æŠ¤äº†ä¸€ä¸ªweakè¡¨ï¼Œç”¨äºå­˜å‚¨æŒ‡å‘æŸä¸ªå¯¹è±¡çš„æ‰€æœ‰weakæŒ‡é’ˆã€‚weakè¡¨å…¶å®æ˜¯ä¸€ä¸ª"><meta name="keywords" content="iOS"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">ä½™ç”Ÿ</a></h3><div class="description"><p>äººå¿…æœ‰æ‰€æ‰§ï¼Œæ–¹èƒ½æœ‰æ‰€æˆã€‚</p></div></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/archives">Arquivo</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/logo.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>weakåˆ°åº•åšäº†äº›å•¥ï¼Ÿ</a></h3></div><div class="post-content"><h1 id="weakåˆ°åº•åšäº†äº›å•¥ï¼Ÿ"><a href="#weakåˆ°åº•åšäº†äº›å•¥ï¼Ÿ" class="headerlink" title="weakåˆ°åº•åšäº†äº›å•¥ï¼Ÿ"></a>weakåˆ°åº•åšäº†äº›å•¥ï¼Ÿ</h1><p>å…¥è¡Œä¹Ÿå¥½å‡ å¹´äº†ï¼Œå…³äºå†…å­˜ç®¡ç†å‡ ä¹æ˜¯é¢è¯•ä¸­å¿…å®šä¼šé—®åˆ°çš„é—®é¢˜ï¼Œå†…å­˜ç®¡ç†ä¸­é—®çš„æœ€å¤šçš„å¤§æ¦‚å°±æ˜¯å¾ªç¯å¼•ç”¨å’Œweakçš„å®ç°äº†ï¼Œå…³äºweakæ€ä¹ˆå°†ä¿®é¥°çš„å¯¹è±¡ç½®ä¸ºnilçš„ï¼Œå¯èƒ½å‡ å¹´å‰çš„å›ç­”å°±æ˜¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">runtimeç»´æŠ¤äº†ä¸€ä¸ªweakè¡¨ï¼Œç”¨äºå­˜å‚¨æŒ‡å‘æŸä¸ªå¯¹è±¡çš„æ‰€æœ‰weakæŒ‡é’ˆã€‚weakè¡¨å…¶å®æ˜¯ä¸€ä¸ªhashï¼ˆå“ˆå¸Œï¼‰è¡¨ï¼ŒKeyæ˜¯æ‰€æŒ‡å¯¹è±¡çš„åœ°å€ï¼ŒValueæ˜¯weakæŒ‡é’ˆçš„åœ°å€ï¼ˆè¿™ä¸ªåœ°å€çš„å€¼æ˜¯æ‰€æŒ‡å¯¹è±¡æŒ‡é’ˆçš„åœ°å€ï¼‰æ•°ç»„ã€‚</div></pre></td></tr></table></figure>
<p>å†ä¹‹åå¯èƒ½å°±æ˜¯weakçš„ä¸‰éƒ¨æ›²ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1ã€åˆå§‹åŒ–æ—¶ï¼šruntimeä¼šè°ƒç”¨objc_initWeakå‡½æ•°ï¼Œåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„weakæŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åœ°å€ã€‚</div><div class="line">2ã€æ·»åŠ å¼•ç”¨æ—¶ï¼šobjc_initWeakå‡½æ•°ä¼šè°ƒç”¨ objc_storeWeak() å‡½æ•°ï¼Œ objc_storeWeak() çš„ä½œç”¨æ˜¯æ›´æ–°æŒ‡é’ˆæŒ‡å‘ï¼Œåˆ›å»ºå¯¹åº”çš„å¼±å¼•ç”¨è¡¨ã€‚</div><div class="line">3ã€é‡Šæ”¾æ—¶ï¼Œè°ƒç”¨clearDeallocatingå‡½æ•°ã€‚clearDeallocatingå‡½æ•°é¦–å…ˆæ ¹æ®å¯¹è±¡åœ°å€è·å–æ‰€æœ‰weakæŒ‡é’ˆåœ°å€çš„æ•°ç»„ï¼Œç„¶åéå†è¿™ä¸ªæ•°ç»„æŠŠå…¶ä¸­çš„æ•°æ®è®¾ä¸ºnilï¼Œæœ€åæŠŠè¿™ä¸ªentryä»weakè¡¨ä¸­åˆ é™¤ï¼Œæœ€åæ¸…ç†å¯¹è±¡çš„è®°å½•ã€‚</div></pre></td></tr></table></figure>
<p>é‚£ä¹ˆä¸Šé¢æåŠåˆ°çš„å‡½æ•°åˆ°åº•éƒ½åšäº†äº›å•¥ï¼Ÿ</p>
<h2 id="objc-initWeak"><a href="#objc-initWeak" class="headerlink" title="objc_initWeak"></a>objc_initWeak</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> HaveOld &#123; DontHaveOld = <span class="literal">false</span>, DoHaveOld = <span class="literal">true</span> &#125;;</div><div class="line"><span class="keyword">enum</span> HaveNew &#123; DontHaveNew = <span class="literal">false</span>, DoHaveNew = <span class="literal">true</span> &#125;;</div><div class="line"></div><div class="line"><span class="function">id <span class="title">objc_initWeak</span><span class="params">(id *location, id newObj)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!newObj) &#123;</div><div class="line">        *location = nil;</div><div class="line">        <span class="keyword">return</span> nil;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> storeWeak&lt;DontHaveOld, DoHaveNew, DoCrashIfDeallocating&gt;(location, (objc_object*)newObj);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„ä»£ç å—ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“<code>objc_initWeak</code>å…¶å®æ˜¯<code>objc_storeWeak</code>çš„å…¥å£ï¼Œä»–ä¸»è¦åˆ¤æ–­äº†ä¿®é¥°çš„å¯¹è±¡æ˜¯å¦æœ‰æ•ˆï¼Œå€˜è‹¥æ˜¯ä¸ªæ— æ•ˆå¯¹è±¡ï¼Œåˆ™ç›´æ¥å°†æŒ‡é’ˆç½®ä¸ºnilï¼Œè¿”å›nilã€‚</p>
<h2 id="storeWeak"><a href="#storeWeak" class="headerlink" title="storeWeak"></a>storeWeak</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//  æ›´æ–°weakå˜é‡</span></div><div class="line"><span class="comment">//  å¦‚æœHaveOldæ˜¯trueï¼Œåˆ™è¯¥å˜é‡ç›®å‰æ˜¯æœ‰å€¼çš„ï¼Œåä¹‹åˆ™éœ€è¦è¢«æ¸…ç©ºï¼Œè¿™ä¸ªå€¼å¯èƒ½ä¼šæ˜¯nil</span></div><div class="line"><span class="comment">//  å¦‚æœHaveNewæ˜¯trueï¼Œåˆ™æ”¹å˜é‡ä¼šè¢«åˆ†é…ä¸Šä¸€ä¸ªæ–°çš„å€¼ï¼Œè¿™ä¸ªå€¼å¯èƒ½ä¼šæ˜¯nil</span></div><div class="line"><span class="comment">//  å¦‚æœcrashIfDeallocatingæ˜¯trueï¼Œåˆ™newObjæ­£åœ¨deallocatingçš„è¿‡ç¨‹ä¸­æˆ–è€…newObjä¸æ”¯æŒè‹¥å¼•ç”¨ï¼Œè¯¥è¿‡ç¨‹è¢«åœæ­¢</span></div><div class="line"><span class="comment">//  å¦‚æœcrashIfDeallocatingæ˜¯falseï¼Œç”¨nilå­˜å‚¨</span></div><div class="line"><span class="keyword">enum</span> CrashIfDeallocating &#123;</div><div class="line">    DontCrashIfDeallocating = <span class="literal">false</span>, DoCrashIfDeallocating = <span class="literal">true</span></div><div class="line">&#125;;</div><div class="line"><span class="keyword">template</span> &lt;HaveOld haveOld, HaveNew haveNew, CrashIfDeallocating crashIfDeallocating&gt;</div><div class="line"><span class="function"><span class="keyword">static</span> id <span class="title">storeWeak</span><span class="params">(id *location, objc_object *newObj)</span> </span>&#123;</div><div class="line">    assert(haveOld  ||  haveNew);</div><div class="line">    <span class="keyword">if</span> (!haveNew) assert(newObj == nil);</div><div class="line"></div><div class="line">    <span class="comment">//    å£°æ˜é¢„å…ˆåˆå§‹åŒ–ç±»</span></div><div class="line">    Class previouslyInitializedClass = nil;</div><div class="line">    <span class="comment">//    å£°æ˜æ—§å€¼</span></div><div class="line">    id oldObj;</div><div class="line">    <span class="comment">//    å£°æ˜æ–°æ—§SideTable</span></div><div class="line">    SideTable *oldTable;</div><div class="line">    SideTable *newTable;</div><div class="line"></div><div class="line">    <span class="comment">// åˆ†åˆ«ä¸ºæ–°å€¼æ—§å€¼åŠ é”</span></div><div class="line"> retry:</div><div class="line">    <span class="keyword">if</span> (haveOld) &#123;</div><div class="line">        oldObj = *location;</div><div class="line">        oldTable = &amp;SideTables()[oldObj];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        oldTable = nil;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (haveNew) &#123;</div><div class="line">        newTable = &amp;SideTables()[newObj];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        newTable = nil;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    SideTable::lockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</div><div class="line"></div><div class="line">    <span class="comment">//  ä¸Šé¢ä»£ç å·²å°†*locationèµ‹å€¼ç»™oldObjï¼Œä¸¤å€¼åº”è¯¥ä¿æŒä¸€è‡´ï¼Œå¦‚æœä¸ç›¸åŒï¼Œåˆ™è¯æ˜oldObjå¯èƒ½åœ¨å…¶ä»–çº¿ç¨‹ä¸­è¢«ä¿®æ”¹</span></div><div class="line">    <span class="keyword">if</span> (haveOld  &amp;&amp;  *location != oldObj) &#123;</div><div class="line">        <span class="comment">//  è§£é”ï¼Œç„¶åå›åˆ°retryé‡æ–°æ“ä½œ</span></div><div class="line">        SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</div><div class="line">        <span class="keyword">goto</span> retry;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//  é˜²æ­¢å¼±å¼•ç”¨é—´çš„æ­»é”</span></div><div class="line">    <span class="comment">//  é€šè¿‡ +initialize ä¿è¯æ‰€æœ‰å¼±å¼•ç”¨çš„ isa æŒ‡å‘éç©º</span></div><div class="line">    <span class="keyword">if</span> (haveNew  &amp;&amp;  newObj) &#123;</div><div class="line">        Class cls = newObj-&gt;getIsa();</div><div class="line">        <span class="comment">//  åˆ¤æ–­isaæŒ‡é’ˆä¸æŒ‡å‘previouslyInitializedClassä¸”å·²ç»åˆå§‹åŒ– (previouslyInitializedClasså¯èƒ½æŒ‡å‘nilï¼Œä¹Ÿå¯èƒ½æŒ‡å‘å‰ä¸€ä¸ªclsçš„åœ°å€)</span></div><div class="line">        <span class="keyword">if</span> (cls != previouslyInitializedClass  &amp;&amp;  !((objc_class *)cls)-&gt;isInitialized()) &#123;</div><div class="line">            SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</div><div class="line">            <span class="comment">//  _class_getNonMetaClass é€šè¿‡ç±»æˆ–è€…å…ƒç±»ï¼Œè¿”å›ä¸€ä¸ªæ™®é€šçš„ç±»</span></div><div class="line">            <span class="comment">//  _class_initialize ä¼šå¯¹æ²¡æœ‰åˆå§‹åŒ–çš„ç±»è¿›è¡Œ +initialize</span></div><div class="line">            _class_initialize(_class_getNonMetaClass(cls, (id)newObj));</div><div class="line">            </div><div class="line">            <span class="comment">//  å¦‚æœè¯¥ç±»å·²ç»å®Œæˆäº†+initializeï¼Œé‚£è‡ªç„¶æ˜¯æœ€å¥½çš„</span></div><div class="line">            <span class="comment">//  å¦‚æœè¯¥ç±»ä¾ç„¶åœ¨æ‰§è¡Œ+initializeä¸­ï¼Œåˆ™å¯èƒ½å‡ºç°å®ƒè§‰å¾—è‡ªå·±æ²¡æœ‰æ„è¯†åˆ°è‡ªå·±åœ¨è°ƒç”¨+initializeçš„è¿‡ç¨‹ä¸­å†æ¬¡è°ƒç”¨+initializeçš„å¯èƒ½æ€§ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶æ·»åŠ ä¿æŠ¤ç­–ç•¥</span></div><div class="line">            <span class="comment">//  å¯¹previouslyInitializedClassæŒ‡é’ˆè¿›è¡Œæ ‡è®°ç„¶åé‡è¯•</span></div><div class="line">            previouslyInitializedClass = cls;</div><div class="line">            </div><div class="line">            <span class="keyword">goto</span> retry;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// å¦‚æœæœ‰æ—§å€¼ï¼Œæ¸…é™¤æ—§å€¼</span></div><div class="line">    <span class="keyword">if</span> (haveOld) &#123;</div><div class="line">        weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// å¦‚æœæœ‰æ–°å€¼ï¼Œåˆ†é…æ–°å€¼</span></div><div class="line">    <span class="keyword">if</span> (haveNew) &#123;</div><div class="line">        newObj = (objc_object *)weak_register_no_lock(&amp;newTable-&gt;weak_table, (id)newObj, location, crashIfDeallocating);</div><div class="line">        <span class="comment">//  å¦‚æœå¼±å¼•ç”¨å­˜å‚¨è¢«æ‹’ï¼Œweak_register_no_lockä¼šè¿”å›nil</span></div><div class="line">        </div><div class="line">        <span class="comment">// å¼•ç”¨è®¡æ•°è¡¨ä¸­æ ‡è®°ä¸ºå¼±å¼•ç”¨</span></div><div class="line">        <span class="keyword">if</span> (newObj  &amp;&amp;  !newObj-&gt;isTaggedPointer()) &#123;</div><div class="line">            newObj-&gt;setWeaklyReferenced_nolock();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">//  ä¸è¦åœ¨åˆ«çš„åœ°æ–¹è®¾ç½®locationï¼Œè¿™é‡Œä¼šè®¾ç½®ä»–</span></div><div class="line">        *location = (id)newObj;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (id)newObj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä»¥ä¸Šä»£ç å¯ä»¥çœ‹å‡º<code>storeWeak</code>å…ˆæ˜¯åšäº†ä¸€ç³»åˆ—çš„æ¡ä»¶åˆ¤æ–­ä»¥åŠä¿æŠ¤æ“ä½œï¼Œä¹‹åå¯¹æ–°å€¼æ—§å€¼è¿›è¡Œäº†æ“ä½œï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯æ¸…é™¤æ—§å€¼åˆ†é…æ–°å€¼ã€‚</p>
<p>ä½†æ˜¯ï¼Œè¿™ä¸ª<code>SideTable</code>æ˜¯å¹²å•¥çš„?</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> SideTable &#123;</div><div class="line">    <span class="comment">//  è‡ªæ—‹é”</span></div><div class="line">    <span class="keyword">spinlock_t</span> slock;</div><div class="line">    <span class="comment">//  å¼•ç”¨è®¡æ•°è¡¨ï¼Œä¸ºäº†é˜²æ­¢å†…å­˜æ³„æ¼ï¼ŒRefcountMapä¼šéšè—å®ƒçš„æŒ‡é’ˆ</span></div><div class="line">    RefcountMap refcnts;</div><div class="line">    <span class="comment">//  å…¨å±€å¼±å¼•ç”¨è¡¨</span></div><div class="line">    <span class="keyword">weak_table_t</span> weak_table;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªç»“æ„ä½“åŒ…å«äº†å¼•ç”¨è®¡æ•°è¡¨å’Œweakè¡¨ï¼Œæƒ³å¿…ä¾¿æ˜¯ç”¨äºç®¡ç†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å’Œweakè¡¨çš„ã€‚</p>
<h2 id="weak-unregister-no-lock"><a href="#weak-unregister-no-lock" class="headerlink" title="weak_unregister_no_lock"></a>weak_unregister_no_lock</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * è§£é™¤å·²ç»æ³¨å†Œçš„å¼±å¼•ç”¨</div><div class="line"> * å°†åœ¨å¼•ç”¨å¯¹ç”¨ä¾ç„¶å­˜åœ¨ï¼Œå¼•ç”¨åœ°å€å³å°†è¢«ç§»é™¤çš„æ—¶å€™è°ƒç”¨</div><div class="line"> * å¦‚æœå½“å‰å¼•ç”¨åœ°å€/å¼•ç”¨å¯¹è±¡ä¸æ˜¯ä¸€ä¸ªæ´»è·ƒçš„å¼±å¼•ç”¨ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš</div><div class="line"> * å¦‚æœæ˜¯0å¼•ç”¨ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš</div><div class="line"> * </div><div class="line"> * @param weak_table å…¨å±€å¼±å¼•ç”¨è¡¨.</div><div class="line"> * @param referent å¼•ç”¨å¯¹è±¡.</div><div class="line"> * @param referrer å¼•ç”¨åœ°å€.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">weak_unregister_no_lock</span><span class="params">(<span class="keyword">weak_table_t</span> *weak_table, id referent_id, id *referrer_id)</span> </span>&#123;</div><div class="line">    objc_object *referent = (objc_object *)referent_id;</div><div class="line">    objc_object **referrer = (objc_object **)referrer_id;</div><div class="line"></div><div class="line">    <span class="keyword">weak_entry_t</span> *entry;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (!referent) <span class="keyword">return</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ((entry = weak_entry_for_referent(weak_table, referent))) &#123;</div><div class="line">        remove_referrer(entry, referrer);</div><div class="line">        <span class="keyword">bool</span> empty = <span class="literal">true</span>;</div><div class="line">        <span class="comment">//  åˆ¤æ–­å½“å‰å¼±å¼•ç”¨æ˜¯å¦å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œå¦‚æœæ´»è·ƒï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸æ“ä½œ</span></div><div class="line">        <span class="keyword">if</span> (entry-&gt;out_of_line()  &amp;&amp;  entry-&gt;num_refs != <span class="number">0</span>) &#123;</div><div class="line">            empty = <span class="literal">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//  å¦‚æœå¼•ç”¨åœ°å€ä¾ç„¶å­˜åœ¨ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸æ“ä½œ</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; WEAK_INLINE_COUNT; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (entry-&gt;inline_referrers[i]) &#123;</div><div class="line">                    empty = <span class="literal">false</span>; </div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (empty) &#123;</div><div class="line">            weak_entry_remove(weak_table, entry);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//  ä¸è¦è®¾ç½® *referrer = nilï¼Œ objc_storeWeak() éœ€è¦æ”¹å˜è¿™ä¸ªå€¼</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>storeWeak</code>ä¸­æ¸…é™¤æ—§å€¼çš„æ“ä½œè°ƒç”¨äº†<code>weak_unregister_no_lock()</code>ï¼Œè¯¥å‡½æ•°æœ€åä¼šè°ƒç”¨<code>weak_entry_removeï¼ˆï¼‰</code>å°†å…¶ä»å¼±å¼•ç”¨è¡¨ä¸­ç§»é™¤ã€‚<br>è¯¥å‡½æ•°é¦–å…ˆåˆ¤æ–­äº†å¼±å¼•ç”¨æ¡ç›®æ˜¯å¦å­˜åœ¨ï¼Œç„¶ååˆ¤æ–­å¯¹è±¡æ˜¯å¦å¤„äºæ´»è·ƒçŠ¶æ€ä»¥åŠå¼•ç”¨åœ°å€æ˜¯å¦è¿˜å­˜åœ¨ï¼Œå¦‚æœå¤„äºæ´»è·ƒçŠ¶æ€æˆ–å¼•ç”¨åœ°å€ä¾ç„¶å­˜åœ¨åˆ™ä¸åšä»»ä½•æ“ä½œï¼Œå¦åˆ™å°†è¯¥å¼±å¼•ç”¨æ¡ç›®ä»å¼±å¼•ç”¨è¡¨ä¸­æ¸…é™¤ã€‚</p>
<h2 id="weak-register-no-lock"><a href="#weak-register-no-lock" class="headerlink" title="weak_register_no_lock"></a>weak_register_no_lock</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * æ³¨å†Œä¸€å¯¹æ–°çš„é”®å€¼å¯¹ï¼ˆå¯¹è±¡ï¼Œå¼±å¼•ç”¨æŒ‡é’ˆï¼‰ï¼Œå¦‚æœè¯¥å¯¹è±¡è¿˜å­˜åœ¨å°±åˆ›å»ºä¸€ä¸ªæ–°çš„å¼±å¼•ç”¨å¯¹è±¡å…¥å£</div><div class="line"> * </div><div class="line"> * @param weak_table å…¨å±€å¼±å¼•ç”¨è¡¨</div><div class="line"> * @param referent å¼±å¼•ç”¨å¯¹è±¡</div><div class="line"> * @param referrer å¼±å¼•ç”¨æŒ‡é’ˆåœ°å€</div><div class="line"> */</div><div class="line"><span class="function">id <span class="title">weak_register_no_lock</span><span class="params">(<span class="keyword">weak_table_t</span> *weak_table, id referent_id, id *referrer_id, <span class="keyword">bool</span> crashIfDeallocating)</span> </span>&#123;</div><div class="line">    objc_object *referent = (objc_object *)referent_id;</div><div class="line">    objc_object **referrer = (objc_object **)referrer_id;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!referent  ||  referent-&gt;isTaggedPointer()) <span class="keyword">return</span> referent_id;</div><div class="line"></div><div class="line">    <span class="comment">// ç¡®ä¿å¼•ç”¨å¯¹è±¡æ˜¯å¦æœ‰æ•ˆ</span></div><div class="line">    <span class="keyword">bool</span> deallocating;</div><div class="line">    <span class="comment">//  hasCustomRR()åˆ¤æ–­æ˜¯å¦æœ‰ä½¿ç”¨è‡ªå®šä¹‰çš„retain/release/autoreleaseï¼ˆè‡ªå®šä¹‰å†…å­˜ç®¡ç†ï¼‰ç­‰æ–¹æ³•</span></div><div class="line">    <span class="keyword">if</span> (!referent-&gt;ISA()-&gt;hasCustomRR()) &#123;</div><div class="line">        <span class="comment">//  rootIsDeallocating å¯¹è±¡æ˜¯å¦æ­£åœ¨é”€æ¯</span></div><div class="line">        deallocating = referent-&gt;rootIsDeallocating();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//  SEL_allowsWeakReference å¯¹è±¡æ˜¯å¦å…è®¸å¼±å¼•ç”¨</span></div><div class="line">        BOOL (*allowsWeakReference)(objc_object *, SEL) = (BOOL(*)(objc_object *, SEL))</div><div class="line">        object_getMethodImplementation((id)referent, SEL_allowsWeakReference);</div><div class="line">        <span class="comment">// åˆ¤æ–­referentå¼±å¼•ç”¨æ–¹æ³•æ˜¯å¦è¢«è½¬å‘</span></div><div class="line">        <span class="keyword">if</span> ((IMP)allowsWeakReference == _objc_msgForward) &#123;</div><div class="line">            <span class="keyword">return</span> nil;</div><div class="line">        &#125;</div><div class="line">        deallocating = ! (*allowsWeakReference)(referent, SEL_allowsWeakReference);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//  å¦‚æœdeallocatingä¸ºtrueï¼Œå¤„ç†ä¸€å“ˆ</span></div><div class="line">    <span class="keyword">if</span> (deallocating) &#123;</div><div class="line">        <span class="keyword">if</span> (crashIfDeallocating) &#123;</div><div class="line">            _objc_fatal(<span class="string">"Cannot form weak reference to instance (%p) of "</span></div><div class="line">                        <span class="string">"class %s. It is possible that this object was "</span></div><div class="line">                        <span class="string">"over-released, or is in the process of deallocation."</span>,</div><div class="line">                        (<span class="keyword">void</span>*)referent, object_getClassName((id)referent));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> nil;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// å°†å¯¹è±¡å­˜å‚¨ï¼Œå¹¶è®°å½•åœ°å€</span></div><div class="line">    <span class="keyword">weak_entry_t</span> *entry;</div><div class="line">    <span class="comment">//  åˆ¤æ–­å¼±å¼•ç”¨è¡¨æ˜¯å¦å­˜åœ¨referent</span></div><div class="line">    <span class="keyword">if</span> ((entry = weak_entry_for_referent(weak_table, referent))) &#123;</div><div class="line">        <span class="comment">//  ä¸ºå¼±å¼•ç”¨æŒ‡é’ˆæ·»åŠ è‡³weak_entry_t</span></div><div class="line">        append_referrer(entry, referrer);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//  å¦‚æœä¸å­˜åœ¨åˆ™æ–°å»ºä¸€ä¸ªweak_entry_t</span></div><div class="line">        <span class="keyword">weak_entry_t</span> new_entry(referent, referrer);</div><div class="line">        <span class="comment">//  å¦‚æœweak_tableè¡¨æ»¡äº†ï¼Œå°±æ‰©å¤§æ§ä»¶</span></div><div class="line">        <span class="comment">//  å½“ weak_table é‡Œçš„å¼±å¼•ç”¨åˆ°è¾¾å®¹é‡3/4æ—¶ï¼Œä¼šå°†å®¹é‡æ‹“å±•ä¸ºä¸¤å€</span></div><div class="line">        weak_grow_maybe(weak_table);</div><div class="line">        <span class="comment">//  å°†å¼±å¼•ç”¨æ’å…¥è¡¨ä¸­</span></div><div class="line">        weak_entry_insert(weak_table, &amp;new_entry);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ä¸è¦è®¾ç½® *referrer = nilï¼Œå› ä¸º objc_storeWeak() å‡½æ•°ä¼šéœ€è¦è¯¥æŒ‡é’ˆ</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> referent_id;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯¥æ–¹æ³•å…ˆæ˜¯åˆ¤æ–­å¼•ç”¨æ˜¯å¦æœ‰æ•ˆï¼Œå¼•ç”¨å¯¹è±¡æ˜¯å¦å¤„äºé”€æ¯ä¸­çš„çŠ¶æ€ï¼Œæœ€åå†åˆ¤æ–­å¼±å¼•ç”¨è¡¨æ˜¯å¦å­˜åœ¨referentï¼Œå­˜åœ¨åˆ™ç›´æ¥æ·»åŠ å¼±å¼•ç”¨ï¼Œä¸å­˜åœ¨åˆ™å…ˆåˆ›å»ºweak_entry_tï¼Œç„¶åå¯¹è¡¨è¿›è¡Œæ‰©å®¹ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ï¼Œæœ€åå°†å¼±å¼•ç”¨æ’å…¥è¡¨ä¸­ã€‚ä¸å¾—ä¸è¯´æºç å±‚é¢çš„æ¡ä»¶åˆ¤æ–­éå¸¸ä¸¥è°¨ï¼Œå„ä¸ªä¼šå‡ºç°å¼‚å¸¸ä½ç½®éƒ½æœ‰ä¸€ä¸ªæ¡ä»¶åˆ¤æ–­ã€‚</p>
<p>ä»¥ä¸Šå°±æ˜¯weakåˆ†é…å€¼çš„ä¸€ç³»åˆ—æ“ä½œäº†ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¯¹è±¡è°ƒç”¨<code>dealloc</code>æ˜¯æ€ä¹ˆå°†å¼±å¼•ç”¨å˜é‡ç½®ä¸ºnilçš„?</p>
<h2 id="è‡ªåŠ¨ç½®ä¸ºnil"><a href="#è‡ªåŠ¨ç½®ä¸ºnil" class="headerlink" title="è‡ªåŠ¨ç½®ä¸ºnil"></a>è‡ªåŠ¨ç½®ä¸ºnil</h2><p>ok,æˆ‘ä»¬éƒ½çŸ¥é“å½“ä¸€ä¸ªå¯¹è±¡å¼•ç”¨è®¡æ•°ä¸º0çš„æ—¶å€™ä¼šè°ƒç”¨<code>dealloc</code>æ–¹æ³•ï¼Œé‚£ä¹ˆä»¥<code>dealloc</code>ä¸ºå…¥å£ï¼Œå»çœ‹çœ‹ç©¶ç«Ÿéƒ½å‘ç”Ÿäº†ä¸€äº›ä»€ä¹ˆäº‹æƒ…ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)dealloc &#123;</div><div class="line">    _objc_rootDealloc(self);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span></div><div class="line">_objc_rootDealloc(id obj)</div><div class="line">&#123;</div><div class="line">    assert(obj);</div><div class="line"></div><div class="line">    obj-&gt;rootDealloc();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">inline</span> <span class="keyword">void</span></div><div class="line">objc_object::rootDealloc()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span>;  <span class="comment">// fixme necessary?</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (fastpath(isa.nonpointer  &amp;&amp;  </div><div class="line">                 !isa.weakly_referenced  &amp;&amp;  </div><div class="line">                 !isa.has_assoc  &amp;&amp;  </div><div class="line">                 !isa.has_cxx_dtor  &amp;&amp;  </div><div class="line">                 !isa.has_sidetable_rc))</div><div class="line">    &#123;</div><div class="line">        assert(!sidetable_present());</div><div class="line">        <span class="built_in">free</span>(<span class="keyword">this</span>);</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        object_dispose((id)<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">id </span></div><div class="line"><span class="title">object_dispose</span><span class="params">(id obj)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!obj) <span class="keyword">return</span> nil;</div><div class="line"></div><div class="line">    objc_destructInstance(obj);    </div><div class="line">    <span class="built_in">free</span>(obj);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> nil;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> *<span class="title">objc_destructInstance</span><span class="params">(id obj)</span> </span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (obj) &#123;</div><div class="line">        <span class="comment">// Read all of the flags at once for performance.</span></div><div class="line">        <span class="keyword">bool</span> cxx = obj-&gt;hasCxxDtor();</div><div class="line">        <span class="keyword">bool</span> assoc = obj-&gt;hasAssociatedObjects();</div><div class="line"></div><div class="line">        <span class="comment">// This order is important.</span></div><div class="line">        <span class="keyword">if</span> (cxx) object_cxxDestruct(obj);</div><div class="line">        <span class="keyword">if</span> (assoc) _object_remove_assocations(obj);</div><div class="line">        obj-&gt;clearDeallocating();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è°ƒç”¨æµç¨‹<br>dealloc -&gt; rootDealloc -&gt; object_dispose -&gt; objc_destructInstance -&gt; clearDeallocating</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">inline</span> <span class="keyword">void</span> </div><div class="line">objc_object::clearDeallocating()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (slowpath(!isa.nonpointer)) &#123;</div><div class="line">        <span class="comment">// Slow path for raw pointer isa.</span></div><div class="line">        sidetable_clearDeallocating();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (slowpath(isa.weakly_referenced  ||  isa.has_sidetable_rc)) &#123;</div><div class="line">        <span class="comment">// Slow path for non-pointer isa with weak refs and/or side table data.</span></div><div class="line">        clearDeallocating_slow();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    assert(!sidetable_present());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>clearDeallocating</code>ä¸­çš„åˆ¤æ–­è¡¨ç¤ºå¼±å¼•ç”¨ä¼šè¿›å…¥<code>clearDeallocating_slow()</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">NEVER_INLINE <span class="keyword">void</span></div><div class="line">objc_object::clearDeallocating_slow()</div><div class="line">&#123;</div><div class="line">    assert(isa.nonpointer  &amp;&amp;  (isa.weakly_referenced || isa.has_sidetable_rc));</div><div class="line"></div><div class="line">    SideTable&amp; table = SideTables()[<span class="keyword">this</span>];</div><div class="line">    table.lock();</div><div class="line">    <span class="keyword">if</span> (isa.weakly_referenced) &#123;</div><div class="line">        weak_clear_no_lock(&amp;table.weak_table, (id)<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isa.has_sidetable_rc) &#123;</div><div class="line">        table.refcnts.erase(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    table.unlock();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆå¼±å¼•ç”¨ä¼šè°ƒç”¨åˆ°<code>weak_clear_no_lock()</code></p>
<h3 id="weak-clear-no-lock"><a href="#weak-clear-no-lock" class="headerlink" title="weak_clear_no_lock"></a>weak_clear_no_lock</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * è¢«dealnocè°ƒç”¨ï¼›æ¸…é™¤å¼±å¼•ç”¨æŒ‡é’ˆ</div><div class="line"> * </div><div class="line"> * @param weak_table å¼±å¼•ç”¨è¡¨</div><div class="line"> * @param referent å°†è¦è¢«é”€æ¯çš„å¯¹è±¡</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> </span></div><div class="line"><span class="title">weak_clear_no_lock</span><span class="params">(<span class="keyword">weak_table_t</span> *weak_table, id referent_id)</span> </div><div class="line">&#123;</div><div class="line">    objc_object *referent = (objc_object *)referent_id;</div><div class="line"></div><div class="line">    <span class="comment">//  å…ˆçœ‹çœ‹æ˜¯ä¸æ˜¯æ²¡æœ‰å¼±å¼•ç”¨</span></div><div class="line">    <span class="keyword">weak_entry_t</span> *entry = weak_entry_for_referent(weak_table, referent);</div><div class="line">    <span class="keyword">if</span> (entry == nil) &#123;</div><div class="line">        <span class="comment">/// XXX shouldn't happen, but does with mismatched CF/objc</span></div><div class="line">        <span class="comment">//printf("XXX no entry for clear deallocating %p\n", referent);</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// zero out references</span></div><div class="line">    <span class="keyword">weak_referrer_t</span> *referrers;</div><div class="line">    <span class="keyword">size_t</span> count;</div><div class="line">    </div><div class="line">    <span class="comment">//  è·å–å¼•ç”¨ä½ç½®ä»¥åŠä¸ªæ•°</span></div><div class="line">    <span class="keyword">if</span> (entry-&gt;out_of_line()) &#123;</div><div class="line">        referrers = entry-&gt;referrers;</div><div class="line">        count = TABLE_SIZE(entry);</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        referrers = entry-&gt;inline_referrers;</div><div class="line">        count = WEAK_INLINE_COUNT;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//  éå†å¼±å¼•ç”¨æ•°ç»„ï¼Œç½®nil</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">        objc_object **referrer = referrers[i];</div><div class="line">        <span class="keyword">if</span> (referrer) &#123;</div><div class="line">            <span class="keyword">if</span> (*referrer == referent) &#123;</div><div class="line">                *referrer = nil;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (*referrer) &#123;</div><div class="line">                _objc_inform(<span class="string">"__weak variable at %p holds %p instead of %p. "</span></div><div class="line">                             <span class="string">"This is probably incorrect use of "</span></div><div class="line">                             <span class="string">"objc_storeWeak() and objc_loadWeak(). "</span></div><div class="line">                             <span class="string">"Break on objc_weak_error to debug.\n"</span>, </div><div class="line">                             referrer, (<span class="keyword">void</span>*)*referrer, (<span class="keyword">void</span>*)referent);</div><div class="line">                objc_weak_error();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//  æœ€åæ¸…é™¤å¼±å¼•ç”¨æ¡ç›®</span></div><div class="line">    weak_entry_remove(weak_table, entry);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯¥æ–¹æ³•è·å–äº†å¯¹è±¡çš„æ‰€æœ‰å¼±å¼•ç”¨å˜é‡ï¼Œç„¶åéå†å¼±å¼•ç”¨æ•°ç»„ï¼Œå°†è¿™äº›å˜é‡åˆ†åˆ«ç½®ä¸ºnilã€‚</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-10-19</span><i class="fa fa-comment-o"></i><a href="/2018/10/19/2018-10-19/#comments">ComentÃ¡rios</a><i class="fa fa-tag"></i><a class="tag" href="/categories/å†…å­˜ç®¡ç†/" title="å†…å­˜ç®¡ç†">å†…å­˜ç®¡ç† </a><a class="tag" href="/tags/weak/" title="weak">weak </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2018/10/19/2018-10-19/,ä½™ç”Ÿ,weakåˆ°åº•åšäº†äº›å•¥ï¼Ÿ,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2018/11/01/2018-10-31/" title="ä»æºç åˆ†æBlockçš„å†…å­˜ç®¡ç†">Post Anterior</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2018/07/19/initializeä½¿ç”¨ä¸å½“é€ æˆçš„é—®é¢˜/" title="initializeä½¿ç”¨ä¸å½“é€ æˆçš„é—®é¢˜">PrÃ³ximo post</a></li></ul></div><a id="comments"></a><div class="ds-thread" data-thread-key="2018/10/19/2018-10-19/" data-title="weakåˆ°åº•åšäº†äº›å•¥ï¼Ÿ" data-url="http://yoursite.com/2018/10/19/2018-10-19/" data-author-key="1"></div><script>var duoshuoQuery = {short_name:"ğŸŸçš„æˆé•¿ä¹‹è·¯"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>