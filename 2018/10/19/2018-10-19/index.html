<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="sthyuhao"><title>weak到底做了些啥？ · 余生</title><meta name="description" content="weak到底做了些啥？入行也好几年了，关于内存管理几乎是面试中必定会问到的问题，内存管理中问的最多的大概就是循环引用和weak的实现了，关于weak怎么将修饰的对象置为nil的，可能几年前的回答就是：
1runtime维护了一个weak表，用于存储指向某个对象的所有weak指针。weak表其实是一个"><meta name="keywords" content="iOS"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">余生</a></h3><div class="description"><p>人必有所执，方能有所成。</p></div></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/logo.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>weak到底做了些啥？</a></h3></div><div class="post-content"><h1 id="weak到底做了些啥？"><a href="#weak到底做了些啥？" class="headerlink" title="weak到底做了些啥？"></a>weak到底做了些啥？</h1><p>入行也好几年了，关于内存管理几乎是面试中必定会问到的问题，内存管理中问的最多的大概就是循环引用和weak的实现了，关于weak怎么将修饰的对象置为nil的，可能几年前的回答就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">runtime维护了一个weak表，用于存储指向某个对象的所有weak指针。weak表其实是一个hash（哈希）表，Key是所指对象的地址，Value是weak指针的地址（这个地址的值是所指对象指针的地址）数组。</div></pre></td></tr></table></figure>
<p>再之后可能就是weak的三部曲：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1、初始化时：runtime会调用objc_initWeak函数，初始化一个新的weak指针指向对象的地址。</div><div class="line">2、添加引用时：objc_initWeak函数会调用 objc_storeWeak() 函数， objc_storeWeak() 的作用是更新指针指向，创建对应的弱引用表。</div><div class="line">3、释放时，调用clearDeallocating函数。clearDeallocating函数首先根据对象地址获取所有weak指针地址的数组，然后遍历这个数组把其中的数据设为nil，最后把这个entry从weak表中删除，最后清理对象的记录。</div></pre></td></tr></table></figure>
<p>那么上面提及到的函数到底都做了些啥？</p>
<h2 id="objc-initWeak"><a href="#objc-initWeak" class="headerlink" title="objc_initWeak"></a>objc_initWeak</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">enum HaveOld &#123; DontHaveOld = false, DoHaveOld = true &#125;;</div><div class="line">enum HaveNew &#123; DontHaveNew = false, DoHaveNew = true &#125;;</div><div class="line"></div><div class="line">id objc_initWeak(id *location, id newObj) &#123;</div><div class="line">    if (!newObj) &#123;</div><div class="line">        *location = nil;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return storeWeak&lt;DontHaveOld, DoHaveNew, DoCrashIfDeallocating&gt;(location, (objc_object*)newObj);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面的代码块，我们可以知道<code>objc_initWeak</code>其实是<code>objc_storeWeak</code>的入口，他主要判断了修饰的对象是否有效，倘若是个无效对象，则直接将指针置为nil，返回nil。</p>
<h2 id="storeWeak"><a href="#storeWeak" class="headerlink" title="storeWeak"></a>storeWeak</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line">//  更新weak变量</div><div class="line">//  如果HaveOld是true，则该变量目前是有值的，反之则需要被清空，这个值可能会是nil</div><div class="line">//  如果HaveNew是true，则改变量会被分配上一个新的值，这个值可能会是nil</div><div class="line">//  如果crashIfDeallocating是true，则newObj正在deallocating的过程中或者newObj不支持若引用，该过程被停止</div><div class="line">//  如果crashIfDeallocating是false，用nil存储</div><div class="line">enum CrashIfDeallocating &#123;</div><div class="line">    DontCrashIfDeallocating = false, DoCrashIfDeallocating = true</div><div class="line">&#125;;</div><div class="line">template &lt;HaveOld haveOld, HaveNew haveNew, CrashIfDeallocating crashIfDeallocating&gt;</div><div class="line">static id storeWeak(id *location, objc_object *newObj) &#123;</div><div class="line">    assert(haveOld  ||  haveNew);</div><div class="line">    if (!haveNew) assert(newObj == nil);</div><div class="line"></div><div class="line">    //    声明预先初始化类</div><div class="line">    Class previouslyInitializedClass = nil;</div><div class="line">    //    声明旧值</div><div class="line">    id oldObj;</div><div class="line">    //    声明新旧SideTable</div><div class="line">    SideTable *oldTable;</div><div class="line">    SideTable *newTable;</div><div class="line"></div><div class="line">    // 分别为新值旧值加锁</div><div class="line"> retry:</div><div class="line">    if (haveOld) &#123;</div><div class="line">        oldObj = *location;</div><div class="line">        oldTable = &amp;SideTables()[oldObj];</div><div class="line">    &#125; else &#123;</div><div class="line">        oldTable = nil;</div><div class="line">    &#125;</div><div class="line">    if (haveNew) &#123;</div><div class="line">        newTable = &amp;SideTables()[newObj];</div><div class="line">    &#125; else &#123;</div><div class="line">        newTable = nil;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    SideTable::lockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</div><div class="line"></div><div class="line">    //  上面代码已将*location赋值给oldObj，两值应该保持一致，如果不相同，则证明oldObj可能在其他线程中被修改</div><div class="line">    if (haveOld  &amp;&amp;  *location != oldObj) &#123;</div><div class="line">        //  解锁，然后回到retry重新操作</div><div class="line">        SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</div><div class="line">        goto retry;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //  防止弱引用间的死锁</div><div class="line">    //  通过 +initialize 保证所有弱引用的 isa 指向非空</div><div class="line">    if (haveNew  &amp;&amp;  newObj) &#123;</div><div class="line">        Class cls = newObj-&gt;getIsa();</div><div class="line">        //  判断isa指针不指向previouslyInitializedClass且已经初始化 (previouslyInitializedClass可能指向nil，也可能指向前一个cls的地址)</div><div class="line">        if (cls != previouslyInitializedClass  &amp;&amp;  !((objc_class *)cls)-&gt;isInitialized()) &#123;</div><div class="line">            SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</div><div class="line">            //  _class_getNonMetaClass 通过类或者元类，返回一个普通的类</div><div class="line">            //  _class_initialize 会对没有初始化的类进行 +initialize</div><div class="line">            _class_initialize(_class_getNonMetaClass(cls, (id)newObj));</div><div class="line">            </div><div class="line">            //  如果该类已经完成了+initialize，那自然是最好的</div><div class="line">            //  如果该类依然在执行+initialize中，则可能出现它觉得自己没有意识到自己在调用+initialize的过程中再次调用+initialize的可能性，我们需要对其添加保护策略</div><div class="line">            //  对previouslyInitializedClass指针进行标记然后重试</div><div class="line">            previouslyInitializedClass = cls;</div><div class="line">            </div><div class="line">            goto retry;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // 如果有旧值，清除旧值</div><div class="line">    if (haveOld) &#123;</div><div class="line">        weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 如果有新值，分配新值</div><div class="line">    if (haveNew) &#123;</div><div class="line">        newObj = (objc_object *)weak_register_no_lock(&amp;newTable-&gt;weak_table, (id)newObj, location, crashIfDeallocating);</div><div class="line">        //  如果弱引用存储被拒，weak_register_no_lock会返回nil</div><div class="line">        </div><div class="line">        // 引用计数表中标记为弱引用</div><div class="line">        if (newObj  &amp;&amp;  !newObj-&gt;isTaggedPointer()) &#123;</div><div class="line">            newObj-&gt;setWeaklyReferenced_nolock();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        //  不要在别的地方设置location，这里会设置他</div><div class="line">        *location = (id)newObj;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</div><div class="line"></div><div class="line">    return (id)newObj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从以上代码可以看出<code>storeWeak</code>先是做了一系列的条件判断以及保护操作，之后对新值旧值进行了操作，简而言之就是清除旧值分配新值。</p>
<p>但是，这个<code>SideTable</code>是干啥的?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">struct SideTable &#123;</div><div class="line">    //  自旋锁</div><div class="line">    spinlock_t slock;</div><div class="line">    //  引用计数表，为了防止内存泄漏，RefcountMap会隐藏它的指针</div><div class="line">    RefcountMap refcnts;</div><div class="line">    //  全局弱引用表</div><div class="line">    weak_table_t weak_table;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个结构体包含了引用计数表和weak表，想必便是用于管理对象的引用计数和weak表的。</p>
<p>##weak_unregister_no_lock<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">/** </div><div class="line"> * 解除已经注册的弱引用</div><div class="line"> * 将在引用对用依然存在，引用地址即将被移除的时候调用</div><div class="line"> * 如果当前引用地址/引用对象不是一个活跃的弱引用，则什么都不做</div><div class="line"> * 如果是0引用，则什么都不做</div><div class="line"> * </div><div class="line"> * @param weak_table 全局弱引用表.</div><div class="line"> * @param referent 引用对象.</div><div class="line"> * @param referrer 引用地址.</div><div class="line"> */</div><div class="line">void weak_unregister_no_lock(weak_table_t *weak_table, id referent_id, id *referrer_id) &#123;</div><div class="line">    objc_object *referent = (objc_object *)referent_id;</div><div class="line">    objc_object **referrer = (objc_object **)referrer_id;</div><div class="line"></div><div class="line">    weak_entry_t *entry;</div><div class="line">    </div><div class="line">    if (!referent) return;</div><div class="line">    </div><div class="line">    if ((entry = weak_entry_for_referent(weak_table, referent))) &#123;</div><div class="line">        remove_referrer(entry, referrer);</div><div class="line">        bool empty = true;</div><div class="line">        //  判断当前弱引用是否处于活跃状态，如果活跃，则什么都不操作</div><div class="line">        if (entry-&gt;out_of_line()  &amp;&amp;  entry-&gt;num_refs != 0) &#123;</div><div class="line">            empty = false;</div><div class="line">        &#125; else &#123;</div><div class="line">            //  如果引用地址依然存在，则什么都不操作</div><div class="line">            for (size_t i = 0; i &lt; WEAK_INLINE_COUNT; i++) &#123;</div><div class="line">                if (entry-&gt;inline_referrers[i]) &#123;</div><div class="line">                    empty = false; </div><div class="line">                    break;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        if (empty) &#123;</div><div class="line">            weak_entry_remove(weak_table, entry);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //  不要设置 *referrer = nil， objc_storeWeak() 需要改变这个值</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>storeWeak</code>中清除旧值的操作调用了<code>weak_unregister_no_lock()</code>，该函数最后会调用<code>weak_entry_remove（）</code>将其从弱引用表中移除。</p>
<p>##weak_register_no_lock</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 注册一对新的键值对（对象，弱引用指针），如果该对象还存在就创建一个新的弱引用对象入口</div><div class="line"> * </div><div class="line"> * @param weak_table 全局弱引用表</div><div class="line"> * @param referent 弱引用对象</div><div class="line"> * @param referrer 弱引用指针地址</div><div class="line"> */</div><div class="line">id weak_register_no_lock(weak_table_t *weak_table, id referent_id, id *referrer_id, bool crashIfDeallocating) &#123;</div><div class="line">    objc_object *referent = (objc_object *)referent_id;</div><div class="line">    objc_object **referrer = (objc_object **)referrer_id;</div><div class="line"></div><div class="line">    if (!referent  ||  referent-&gt;isTaggedPointer()) return referent_id;</div><div class="line"></div><div class="line">    // 确保引用对象是否有效</div><div class="line">    bool deallocating;</div><div class="line">    //  hasCustomRR()判断是否有使用自定义的retain/release/autorelease（自定义内存管理）等方法</div><div class="line">    if (!referent-&gt;ISA()-&gt;hasCustomRR()) &#123;</div><div class="line">        //  rootIsDeallocating 对象是否正在销毁</div><div class="line">        deallocating = referent-&gt;rootIsDeallocating();</div><div class="line">    &#125; else &#123;</div><div class="line">        //  SEL_allowsWeakReference 对象是否允许弱引用</div><div class="line">        BOOL (*allowsWeakReference)(objc_object *, SEL) = (BOOL(*)(objc_object *, SEL))</div><div class="line">        object_getMethodImplementation((id)referent, SEL_allowsWeakReference);</div><div class="line">        // 判断referent弱引用方法是否被转发</div><div class="line">        if ((IMP)allowsWeakReference == _objc_msgForward) &#123;</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">        deallocating = ! (*allowsWeakReference)(referent, SEL_allowsWeakReference);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //  如果deallocating为true，处理一哈</div><div class="line">    if (deallocating) &#123;</div><div class="line">        if (crashIfDeallocating) &#123;</div><div class="line">            _objc_fatal(&quot;Cannot form weak reference to instance (%p) of &quot;</div><div class="line">                        &quot;class %s. It is possible that this object was &quot;</div><div class="line">                        &quot;over-released, or is in the process of deallocation.&quot;,</div><div class="line">                        (void*)referent, object_getClassName((id)referent));</div><div class="line">        &#125; else &#123;</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 将对象存储，并记录地址</div><div class="line">    weak_entry_t *entry;</div><div class="line">    //  判断弱引用表是否存在referent</div><div class="line">    if ((entry = weak_entry_for_referent(weak_table, referent))) &#123;</div><div class="line">        //  为弱引用指针添加至weak_entry_t</div><div class="line">        append_referrer(entry, referrer);</div><div class="line">    &#125; else &#123;</div><div class="line">        //  如果不存在则新建一个weak_entry_t</div><div class="line">        weak_entry_t new_entry(referent, referrer);</div><div class="line">        //  如果weak_table表满了，就扩大控件</div><div class="line">        //  当 weak_table 里的弱引用到达容量3/4时，会将容量拓展为两倍</div><div class="line">        weak_grow_maybe(weak_table);</div><div class="line">        //  将弱引用插入表中</div><div class="line">        weak_entry_insert(weak_table, &amp;new_entry);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 不要设置 *referrer = nil，因为 objc_storeWeak() 函数会需要该指针</div><div class="line"></div><div class="line">    return referent_id;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法显示判断引用是否有效，引用对象是否处于销毁中的状态，最后再判断弱引用表是否存在referent，存在则直接添加弱引用，不存在则先创建weak_entry_t，然后对表进行扩容（如果需要的话），最后将弱引用插入表中。不得不说源码层面的条件判断非常严谨，各个会出现异常位置都有一个条件判断，而咱们日常写代码时考虑的就没那么严谨。</p>
<p>以上就是weak分配值的一系列操作了，还有一个问题就是对象调用<code>dealloc</code>是怎么将弱引用变量置为nil的?</p>
<p>##自动置为nil<br>ok,我们都知道当一个对象引用计数为0的时候会调用<code>dealloc</code>方法，那么以<code>dealloc</code>为入口，去看看究竟都发生了一些什么事情。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">- (void)dealloc &#123;</div><div class="line">    _objc_rootDealloc(self);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">_objc_rootDealloc(id obj)</div><div class="line">&#123;</div><div class="line">    assert(obj);</div><div class="line"></div><div class="line">    obj-&gt;rootDealloc();</div><div class="line">&#125;</div><div class="line"></div><div class="line">inline void</div><div class="line">objc_object::rootDealloc()</div><div class="line">&#123;</div><div class="line">    if (isTaggedPointer()) return;  // fixme necessary?</div><div class="line"></div><div class="line">    if (fastpath(isa.nonpointer  &amp;&amp;  </div><div class="line">                 !isa.weakly_referenced  &amp;&amp;  </div><div class="line">                 !isa.has_assoc  &amp;&amp;  </div><div class="line">                 !isa.has_cxx_dtor  &amp;&amp;  </div><div class="line">                 !isa.has_sidetable_rc))</div><div class="line">    &#123;</div><div class="line">        assert(!sidetable_present());</div><div class="line">        free(this);</div><div class="line">    &#125; </div><div class="line">    else &#123;</div><div class="line">        object_dispose((id)this);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">id </div><div class="line">object_dispose(id obj)</div><div class="line">&#123;</div><div class="line">    if (!obj) return nil;</div><div class="line"></div><div class="line">    objc_destructInstance(obj);    </div><div class="line">    free(obj);</div><div class="line"></div><div class="line">    return nil;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void *objc_destructInstance(id obj) </div><div class="line">&#123;</div><div class="line">    if (obj) &#123;</div><div class="line">        // Read all of the flags at once for performance.</div><div class="line">        bool cxx = obj-&gt;hasCxxDtor();</div><div class="line">        bool assoc = obj-&gt;hasAssociatedObjects();</div><div class="line"></div><div class="line">        // This order is important.</div><div class="line">        if (cxx) object_cxxDestruct(obj);</div><div class="line">        if (assoc) _object_remove_assocations(obj);</div><div class="line">        obj-&gt;clearDeallocating();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return obj;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用流程<br>dealloc -&gt; rootDealloc -&gt; object_dispose -&gt; objc_destructInstance -&gt; clearDeallocating</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">inline void </div><div class="line">objc_object::clearDeallocating()</div><div class="line">&#123;</div><div class="line">    if (slowpath(!isa.nonpointer)) &#123;</div><div class="line">        // Slow path for raw pointer isa.</div><div class="line">        sidetable_clearDeallocating();</div><div class="line">    &#125;</div><div class="line">    else if (slowpath(isa.weakly_referenced  ||  isa.has_sidetable_rc)) &#123;</div><div class="line">        // Slow path for non-pointer isa with weak refs and/or side table data.</div><div class="line">        clearDeallocating_slow();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    assert(!sidetable_present());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>clearDeallocating</code>中的判断表示弱引用会进入<code>clearDeallocating_slow()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">NEVER_INLINE void</div><div class="line">objc_object::clearDeallocating_slow()</div><div class="line">&#123;</div><div class="line">    assert(isa.nonpointer  &amp;&amp;  (isa.weakly_referenced || isa.has_sidetable_rc));</div><div class="line"></div><div class="line">    SideTable&amp; table = SideTables()[this];</div><div class="line">    table.lock();</div><div class="line">    if (isa.weakly_referenced) &#123;</div><div class="line">        weak_clear_no_lock(&amp;table.weak_table, (id)this);</div><div class="line">    &#125;</div><div class="line">    if (isa.has_sidetable_rc) &#123;</div><div class="line">        table.refcnts.erase(this);</div><div class="line">    &#125;</div><div class="line">    table.unlock();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终弱引用会调用到<code>weak_clear_no_lock()</code></p>
<h3 id="weak-clear-no-lock"><a href="#weak-clear-no-lock" class="headerlink" title="weak_clear_no_lock"></a>weak_clear_no_lock</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 被dealloc调用；清除弱引用指针</div><div class="line"> * </div><div class="line"> * @param weak_table 弱引用表</div><div class="line"> * @param referent 将要被销毁的对象</div><div class="line"> */</div><div class="line">void </div><div class="line">weak_clear_no_lock(weak_table_t *weak_table, id referent_id) </div><div class="line">&#123;</div><div class="line">    objc_object *referent = (objc_object *)referent_id;</div><div class="line"></div><div class="line">    //  先看看是不是没有弱引用</div><div class="line">    weak_entry_t *entry = weak_entry_for_referent(weak_table, referent);</div><div class="line">    if (entry == nil) &#123;</div><div class="line">        /// XXX shouldn&apos;t happen, but does with mismatched CF/objc</div><div class="line">        //printf(&quot;XXX no entry for clear deallocating %p\n&quot;, referent);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // zero out references</div><div class="line">    weak_referrer_t *referrers;</div><div class="line">    size_t count;</div><div class="line">    </div><div class="line">    //  获取引用位置以及个数</div><div class="line">    if (entry-&gt;out_of_line()) &#123;</div><div class="line">        referrers = entry-&gt;referrers;</div><div class="line">        count = TABLE_SIZE(entry);</div><div class="line">    &#125; </div><div class="line">    else &#123;</div><div class="line">        referrers = entry-&gt;inline_referrers;</div><div class="line">        count = WEAK_INLINE_COUNT;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //  遍历弱引用数组，置nil</div><div class="line">    for (size_t i = 0; i &lt; count; ++i) &#123;</div><div class="line">        objc_object **referrer = referrers[i];</div><div class="line">        if (referrer) &#123;</div><div class="line">            if (*referrer == referent) &#123;</div><div class="line">                *referrer = nil;</div><div class="line">            &#125;</div><div class="line">            else if (*referrer) &#123;</div><div class="line">                _objc_inform(&quot;__weak variable at %p holds %p instead of %p. &quot;</div><div class="line">                             &quot;This is probably incorrect use of &quot;</div><div class="line">                             &quot;objc_storeWeak() and objc_loadWeak(). &quot;</div><div class="line">                             &quot;Break on objc_weak_error to debug.\n&quot;, </div><div class="line">                             referrer, (void*)*referrer, (void*)referent);</div><div class="line">                objc_weak_error();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //  最后清除弱引用条目</div><div class="line">    weak_entry_remove(weak_table, entry);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法获取了对象的所有弱引用变量，然后遍历弱引用数组，将这些变量分别置为nil。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-10-19</span><i class="fa fa-tag"></i><a class="tag" href="/categories/内存管理/" title="内存管理">内存管理 </a><a class="tag" href="/tags/weak/" title="weak">weak </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2018/10/19/2018-10-19/,余生,weak到底做了些啥？,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2018/07/19/initialize使用不当造成的问题/" title="initialize使用不当造成的问题">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>