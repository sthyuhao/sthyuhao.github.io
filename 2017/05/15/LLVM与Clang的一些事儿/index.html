<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="sthyuhao"><title>LLVMä¸Clangçš„ä¸€äº›äº‹å„¿ Â· ä½™ç”Ÿ</title><meta name="description" content="åœ¨è¯´è¿™ç¯‡æ–‡ç« ä¹‹å‰ï¼Œé¦–å…ˆæˆ‘ä»¬å¸¦å…¥ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨Xcodeä¸­æˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„ä¸€ä¸ªç»„åˆé”®cmd+bæŒ‰ä¸‹ä¹‹åéƒ½è¿›è¡Œäº†å“ªä¸€äº›å·¥ä½œï¼Ÿä¼Ÿå¤§çš„ARCå†…å­˜ç®¡ç†æ–¹å¼åˆæ˜¯å¦‚ä½•å®ç°å†…å­˜ç®¡ç†çš„ï¼Ÿ
åˆæˆ–è€…æˆ‘ä¸äº†è§£ç¼–è¯‘è¿‡ç¨‹ä»£ç ç…§æ ·æ’¸å¾—é£èµ·ï¼Œæ‘¸é€è¿™æ™¦æ¶©éš¾ç†è§£çš„ä¸œè¥¿æœ‰ä»€ä¹ˆç”¨ï¼Ÿ
ä¸‹é¢è¦å¼€å§‹å•°å—¦äº†LLVMç®€ä»‹-æ¥è‡ªhttps://zh.wi"><meta name="keywords" content="iOS"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">ä½™ç”Ÿ</a></h3><div class="description"><p>äººå¿…æœ‰æ‰€æ‰§ï¼Œæ–¹èƒ½æœ‰æ‰€æˆã€‚</p></div></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/archives">Arquivo</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/logo.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>LLVMä¸Clangçš„ä¸€äº›äº‹å„¿</a></h3></div><div class="post-content"><p>åœ¨è¯´è¿™ç¯‡æ–‡ç« ä¹‹å‰ï¼Œé¦–å…ˆæˆ‘ä»¬å¸¦å…¥ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨Xcodeä¸­æˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„ä¸€ä¸ªç»„åˆé”®<code>cmd+b</code>æŒ‰ä¸‹ä¹‹åéƒ½è¿›è¡Œäº†å“ªä¸€äº›å·¥ä½œï¼Ÿä¼Ÿå¤§çš„ARCå†…å­˜ç®¡ç†æ–¹å¼åˆæ˜¯å¦‚ä½•å®ç°å†…å­˜ç®¡ç†çš„ï¼Ÿ</p>
<p>åˆæˆ–è€…æˆ‘ä¸äº†è§£ç¼–è¯‘è¿‡ç¨‹ä»£ç ç…§æ ·æ’¸å¾—é£èµ·ï¼Œæ‘¸é€è¿™æ™¦æ¶©éš¾ç†è§£çš„ä¸œè¥¿æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</p>
<h2 id="ä¸‹é¢è¦å¼€å§‹å•°å—¦äº†"><a href="#ä¸‹é¢è¦å¼€å§‹å•°å—¦äº†" class="headerlink" title="ä¸‹é¢è¦å¼€å§‹å•°å—¦äº†"></a>ä¸‹é¢è¦å¼€å§‹å•°å—¦äº†</h2><h3 id="LLVMç®€ä»‹-æ¥è‡ªhttps-zh-wikipedia-org-wiki-LLVM"><a href="#LLVMç®€ä»‹-æ¥è‡ªhttps-zh-wikipedia-org-wiki-LLVM" class="headerlink" title="LLVMç®€ä»‹-æ¥è‡ªhttps://zh.wikipedia.org/wiki/LLVM"></a>LLVMç®€ä»‹-æ¥è‡ª<a href="https://zh.wikipedia.org/wiki/LLVM" target="_blank" rel="external">https://zh.wikipedia.org/wiki/LLVM</a></h3><p>LLVMé¡¹ç›®çš„å‘å±•èµ·æºäº2000å¹´ä¼Šåˆ©è¯ºä¼Šå¤§å­¦å„å·´çº³-é¦™æ§Ÿåˆ†æ ¡ç»´å…‹æ‹‰å§†Â·è‰¾å¤«ï¼ˆVikram Adveï¼‰ä¸å…‹é‡Œæ–¯Â·æ‹‰ç‰¹çº³ï¼ˆChris Lattnerï¼‰çš„ç ”ç©¶ï¼Œä»–ä»¬æƒ³è¦ä¸ºæ‰€æœ‰é™æ€åŠåŠ¨æ€è¯­è¨€åˆ›é€ å‡ºåŠ¨æ€çš„ç¼–è¯‘æŠ€æœ¯ã€‚LLVMæ˜¯ä»¥BSDæˆæƒæ¥å‘å±•çš„å¼€æºè½¯ä»¶ã€‚2005å¹´ï¼Œè‹¹æœç”µè„‘é›‡ç”¨äº†å…‹é‡Œæ–¯Â·æ‹‰ç‰¹çº³åŠä»–çš„å›¢é˜Ÿä¸ºè‹¹æœç”µè„‘å¼€å‘åº”ç”¨ç¨‹åºç³»ç»Ÿï¼ŒLLVMä¸ºç°ä»ŠMac OS XåŠiOSå¼€å‘å·¥å…·çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>LLVMçš„å‘½åæœ€æ—©æºè‡ªäºåº•å±‚è™šæ‹Ÿæœºï¼ˆLow Level Virtual Machineï¼‰çš„é¦–å­—æ¯ç¼©å†™ï¼Œç”±äºè¿™ä¸ªé¡¹ç›®çš„èŒƒå›´å¹¶ä¸å±€é™äºåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼Œè¿™ä¸ªç¼©å†™å¯¼è‡´äº†å¹¿æ³›çš„ç–‘æƒ‘ã€‚LLVMå¼€å§‹æˆé•¿ä¹‹åï¼Œæˆä¸ºä¼—å¤šç¼–è¯‘å·¥å…·åŠä½çº§å·¥å…·æŠ€æœ¯çš„ç»Ÿç§°ï¼Œä½¿å¾—è¿™ä¸ªåå­—å˜å¾—æ›´ä¸è´´åˆ‡ï¼Œå¼€å‘è€…å› è€Œå†³å®šæ”¾å¼ƒè¿™ä¸ªç¼©å†™çš„æ„æ¶µï¼Œç°ä»ŠLLVMå·²å•çº¯æˆä¸ºä¸€ä¸ªå“ç‰Œï¼Œé€‚ç”¨äºLLVMä¸‹çš„æ‰€æœ‰é¡¹ç›®ï¼ŒåŒ…å«LLVMä¸­ä»‹ç ï¼ˆLLVM IRï¼‰ã€LLVMé™¤é”™å·¥å…·ã€LLVM C++æ ‡å‡†åº“ç­‰ã€‚</p>
<hr>
<h3 id="å…³äºswiftä¹‹çˆ¶åŠ å…¥Appleæœ‰ä¸ªæœ‰è¶£çš„æ•…äº‹"><a href="#å…³äºswiftä¹‹çˆ¶åŠ å…¥Appleæœ‰ä¸ªæœ‰è¶£çš„æ•…äº‹" class="headerlink" title="å…³äºswiftä¹‹çˆ¶åŠ å…¥Appleæœ‰ä¸ªæœ‰è¶£çš„æ•…äº‹"></a>å…³äºswiftä¹‹çˆ¶åŠ å…¥Appleæœ‰ä¸ªæœ‰è¶£çš„æ•…äº‹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Xcode3ä¹‹å‰ï¼Œç”¨çš„æ˜¯GCC</div><div class="line">Xcode3,GCCä»ç„¶ä¿ç•™ï¼Œä½†æ˜¯ä¹Ÿæ¨å‡ºäº†LLVMï¼Œè‹¹æœæ¨èLLVM-GCCæ··åˆç¼–è¯‘å™¨ï¼Œä½†è¿˜ä¸æ˜¯é»˜è®¤ç¼–è¯‘å™¨</div><div class="line">Xcode4,LLVM-GCCæˆä¸ºé»˜è®¤ç¼–è¯‘å™¨ï¼Œä½†GCCä»ä¿ç•™</div><div class="line">Xcode4.2,LLVM3.0æˆä¸ºé»˜è®¤ç¼–è¯‘å™¨,çº¯ç”¨GCCä¸å¤å¯èƒ½</div><div class="line">Xcode4.6,LLVMå‡çº§åˆ°4.2ç‰ˆæœ¬</div><div class="line">Xcode5,LLVM-GCCè¢«é—å¼ƒï¼Œæ–°çš„ç¼–è¯‘å™¨æ˜¯LLVM5.0ï¼Œä»GCCè¿‡æ¸¡åˆ°LLVMçš„æ—¶ä»£æ­£å¼å®Œæˆ</div></pre></td></tr></table></figure>
<p>å½“æ—¶è‹¹æœå¯¹Objective-Cæ–°å¢äº†è®¸å¤šç‰¹æ€§ï¼Œä½†è¿™æ—¶çš„Appleä½¿ç”¨çš„æ˜¯å½“æ—¶ä¸€æ‰‹é®å¤©çš„GCCä½œä¸ºå‰ç«¯ã€‚GCCå¹¶ä¸ä¸ºè¿™äº›æ–°ç‰¹æ€§ä¹°è´¦â€“ä¸ç»™å®ç°ï¼Œå› æ­¤ç´¢æ€§åæ¥ä¸¤è€… åˆ†æˆä¸¤æ¡åˆ†æ”¯åˆ†åˆ«å¼€å‘ï¼Œè¿™ä¹Ÿé€ æˆAppleçš„ç¼–è¯‘å™¨ç‰ˆæœ¬è¿œè½åäºGCCçš„å®˜æ–¹ç‰ˆæœ¬ã€‚å¹¶ä¸”GCCçš„ä»£ç è€¦åˆåº¦å¤ªé«˜ï¼Œä¸å¥½ç‹¬ç«‹ï¼Œè€Œä¸”è¶Šæ˜¯åæœŸçš„ç‰ˆæœ¬ï¼Œä»£ç è´¨é‡è¶Šå·®7ï¼Œä½†Appleæƒ³åšçš„å¾ˆå¤šåŠŸèƒ½ï¼ˆæ¯”å¦‚æ›´å¥½çš„IDEæ”¯æŒï¼‰éœ€è¦æ¨¡å—åŒ–çš„æ–¹å¼æ¥è°ƒç”¨GCCï¼Œä½†GCCä¸€ç›´ä¸ç»™åšã€‚ã€ŠGCCè¿è¡Œç¯å¢ƒè±å…æ¡æ¬¾ ï¼ˆè‹±æ–‡ç‰ˆï¼‰8ã€‹ä»æ ¹æœ¬ä¸Šé™åˆ¶äº†LLVM-GCCçš„å¼€å‘ã€‚ æ‰€ä»¥ï¼Œè¿™ç§ä¸å’Œè®©Appleä¸€ç›´åœ¨å¯»æ‰¾ä¸€ä¸ªé«˜æ•ˆçš„ã€æ¨¡å—åŒ–çš„ã€åè®®æ›´æ”¾æ¾çš„å¼€æºæ›¿ä»£å“ã€‚è€ŒUIUCçš„é«˜æç”ŸChris Lattnerçš„LLVMæ˜¾ç„¶æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„é€‰æ‹©ã€‚</p>
<hr>
<h3 id="Clang-a-C-language-family-frontend-for-LLVM"><a href="#Clang-a-C-language-family-frontend-for-LLVM" class="headerlink" title="Clang - a C language family frontend for LLVM"></a>Clang - a C language family frontend for LLVM</h3><p>Clangï¼ˆå‘éŸ³ä¸º/ËˆklÃ¦Å‹/ï¼‰ æ˜¯ä¸€ä¸ªCã€C++ã€Objective-Cå’ŒObjective-C++ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘å™¨å‰ç«¯ã€‚å®ƒé‡‡ç”¨äº†åº•å±‚è™šæ‹Ÿæœºï¼ˆLLVMï¼‰ä½œä¸ºå…¶åç«¯ã€‚å®ƒçš„ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªGNUç¼–è¯‘å™¨å¥—è£…ï¼ˆGCCï¼‰çš„æ›¿ä»£å“ã€‚ä½œè€…æ˜¯å…‹é‡Œæ–¯Â·æ‹‰ç‰¹çº³ï¼Œåœ¨è‹¹æœå…¬å¸çš„èµåŠ©æ”¯æŒä¸‹è¿›è¡Œå¼€å‘ï¼Œè€Œæºä»£ç æˆæƒæ˜¯ä½¿ç”¨ç±»BSDçš„ä¼Šåˆ©è¯ºä¼Šå¤§å­¦å„å·´çº³-é¦™æ§Ÿåˆ†æ ¡å¼€æºç è®¸å¯ã€‚<br>Clangé¡¹ç›®åŒ…æ‹¬Clangå‰ç«¯å’ŒClangé™æ€åˆ†æå™¨ç­‰ã€‚</p>
<p>Clangçš„åœ¨å‡ºç”Ÿä¹‹å‰å°±å·²ç»æ˜ç¡®äº†ä»–çš„ä½¿å‘½â€”â€”å¹²æ‰è¯¥æ­»çš„GCCã€‚æœ‰äº†LLVM+Clangï¼Œä»æ­¤ï¼Œè‹¹æœçš„å¼€å‘é¢è²Œç„•ç„¶ä¸€æ–°ã€‚ä»æ­¤æ‘†è„±äº†GCCçš„é™åˆ¶ã€‚å®¢è§‚çš„è¯´GCCæ˜¯æœ‰å¾ˆå¤šçš„ä¼˜ç‚¹ï¼Œä¾‹å¦‚æ”¯æŒå¤šå¹³å°ï¼Œå¾ˆæµè¡Œï¼ŒåŸºäºCæ— éœ€C++ç¼–è¯‘å™¨å³å¯ç¼–è¯‘ã€‚è¿™äº›ä¼˜ç‚¹åˆ°è‹¹æœé‚£å°±å¯èƒ½æ˜¯ç¼ºç‚¹äº†ï¼Œè‹¹æœéœ€è¦çš„æ˜¯â€”â€”å¿«ã€‚è¿™æ­£æ˜¯Clangçš„ä¼˜ç‚¹ï¼Œé™¤äº†å¿«ï¼Œå®ƒè¿˜æœ‰ä¸GCCå…¼å®¹ï¼Œå†…å­˜å ç”¨å°ï¼Œè¯Šæ–­ä¿¡æ¯å¯è¯»æ€§å¼ºï¼Œæ˜“æ‰©å±•ï¼Œæ˜“äºIDEé›†æˆç­‰ç­‰ä¼˜ç‚¹ã€‚æœ‰ä¸ªæµ‹è¯•æ•°æ®:Clangç¼–è¯‘Objective-Cä»£ç æ—¶é€Ÿåº¦ä¸ºGCCçš„3å€ã€‚</p>
<hr>
<h3 id="LLDB"><a href="#LLDB" class="headerlink" title="LLDB"></a>LLDB</h3><p>GCCæœ‰ä¸ªå¼ºå¤§çš„è¯Šæ–­å·¥å…·â€”â€”GDBï¼Œç›¸å¯¹åº”çš„Clangä¸‹çº é”™å·¥å…·å°±æ˜¯LLDBã€‚å¯¹äºLLDBå¤§å®¶åº”è¯¥éƒ½ä¸é™Œç”Ÿï¼Œå®ƒç»§æ‰¿äº†GDBçš„ä¼˜ç‚¹ï¼Œå¼¥è¡¥GDBçš„ä¸è¶³ã€‚iOSå¼€å‘è€…ä»gbdè¿‡æ¸¡åˆ°lldbæ²¡æœ‰ä»»ä½•ä¸é€‚åº”æ„Ÿï¼Œæœ€ç›´ç™½çš„åŸå› å°±æ˜¯lldbå’Œgdbå¸¸ç”¨çš„å‘½ä»¤å¾ˆå¤šéƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¾‹å¦‚å¸¸ç”¨çš„poç­‰ã€‚</p>
<h2 id="å•°å—¦åˆ°æ­¤ç»“æŸ"><a href="#å•°å—¦åˆ°æ­¤ç»“æŸ" class="headerlink" title="å•°å—¦åˆ°æ­¤ç»“æŸ"></a>å•°å—¦åˆ°æ­¤ç»“æŸ</h2><h3 id="iOSç¼–è¯‘è¿‡ç¨‹"><a href="#iOSç¼–è¯‘è¿‡ç¨‹" class="headerlink" title="iOSç¼–è¯‘è¿‡ç¨‹"></a>iOSç¼–è¯‘è¿‡ç¨‹</h3><p><img src="https://raw.githubusercontent.com/sthyuhao/BlogImgZone/master/50b10bb214170deb37de425f6e9598.jpg" alt=""></p>
<p>Objective-Cä¸swiftéƒ½é‡‡ç”¨Clangä½œä¸ºç¼–è¯‘å™¨å‰ç«¯ï¼Œç¼–è¯‘å™¨å‰ç«¯ä¸»è¦è¿›è¡Œè¯­æ³•åˆ†æï¼Œè¯­ä¹‰åˆ†æï¼Œç”Ÿæˆä¸­é—´ä»£ç ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼šè¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œå¦‚æœå‘ç°é”™è¯¯æˆ–è€…è­¦å‘Šä¼šæ ‡æ³¨å‡ºæ¥åœ¨å“ªä¸€è¡Œã€‚<br><img src="https://raw.githubusercontent.com/sthyuhao/BlogImgZone/master/6195d8a0c78405defca857e1274f61.png" alt=""></p>
<p>ç¼–è¯‘å™¨åç«¯ä¼šè¿›è¡Œæœºå™¨æ— å…³çš„ä»£ç ä¼˜åŒ–ï¼Œç”Ÿæˆæœºå™¨è¯­è¨€ï¼Œå¹¶ä¸”è¿›è¡Œæœºå™¨ç›¸å…³çš„ä»£ç ä¼˜åŒ–ï¼Œæ ¹æ®ä¸åŒçš„ç³»ç»Ÿæ¶æ„ç”Ÿæˆä¸åŒçš„æœºå™¨ç ã€‚</p>
<p>C++,Objective Céƒ½æ˜¯ç¼–è¯‘è¯­è¨€ã€‚ç¼–è¯‘è¯­è¨€åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå¿…é¡»å…ˆé€šè¿‡ç¼–è¯‘å™¨ç”Ÿæˆæœºå™¨ç ã€‚</p>
<p><img src="https://raw.githubusercontent.com/sthyuhao/BlogImgZone/master/9d1badbd48d13028f4e28d14271885.jpg" alt=""></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨xcodeæŒ‰ä¸‹cmd+Bä¹‹åçš„å·¥ä½œæµç¨‹ã€‚</p>
<p><strong>é¢„å¤„ç†ï¼ˆPre-processï¼‰</strong>ï¼šä»–çš„ä¸»è¦å·¥ä½œå°±æ˜¯å°†å®æ›¿æ¢ï¼Œåˆ é™¤æ³¨é‡Šå±•å¼€å¤´æ–‡ä»¶ï¼Œç”Ÿæˆ.iæ–‡ä»¶ã€‚<br><strong>è¯æ³•åˆ†æ ï¼ˆLexical Analysisï¼‰</strong>ï¼šå°†ä»£ç åˆ‡æˆä¸€ä¸ªä¸ª tokenï¼Œæ¯”å¦‚å¤§å°æ‹¬å·ï¼Œç­‰äºå·è¿˜æœ‰å­—ç¬¦ä¸²ç­‰ã€‚æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­å°†å­—ç¬¦åºåˆ—è½¬æ¢ä¸ºæ ‡è®°åºåˆ—çš„è¿‡ç¨‹ã€‚<br><strong>è¯­æ³•åˆ†æï¼ˆSemantic Analysisï¼‰</strong>ï¼šéªŒè¯è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼Œç„¶åå°†æ‰€æœ‰èŠ‚ç‚¹ç»„æˆæŠ½è±¡è¯­æ³•æ ‘ AST ã€‚ç”± Clang ä¸­ Parser å’Œ Sema é…åˆå®Œæˆ<br><strong>é™æ€åˆ†æï¼ˆStatic Analysisï¼‰</strong>ï¼šä½¿ç”¨å®ƒæ¥è¡¨ç¤ºç”¨äºåˆ†ææºä»£ç ä»¥ä¾¿è‡ªåŠ¨å‘ç°é”™è¯¯ã€‚<br><strong>ä¸­é—´ä»£ç ç”Ÿæˆï¼ˆCode Generationï¼‰</strong>ï¼šå¼€å§‹IRä¸­é—´ä»£ç çš„ç”Ÿæˆäº†ï¼ŒCodeGen ä¼šè´Ÿè´£å°†è¯­æ³•æ ‘è‡ªé¡¶å‘ä¸‹éå†é€æ­¥ç¿»è¯‘æˆ LLVM IRï¼ŒIR æ˜¯ç¼–è¯‘è¿‡ç¨‹çš„å‰ç«¯çš„è¾“å‡ºåç«¯çš„è¾“å…¥ã€‚<br><strong>ä¼˜åŒ–ï¼ˆOptimizeï¼‰</strong>ï¼šLLVM ä¼šå»åšäº›ä¼˜åŒ–å·¥ä½œï¼Œåœ¨ Xcode çš„ç¼–è¯‘è®¾ç½®é‡Œä¹Ÿå¯ä»¥è®¾ç½®ä¼˜åŒ–çº§åˆ«-01ï¼Œ-03ï¼Œ-0sï¼Œè¿˜å¯ä»¥å†™äº›è‡ªå·±çš„ Passï¼Œå®˜æ–¹æœ‰æ¯”è¾ƒå®Œæ•´çš„ Pass æ•™ç¨‹ï¼š Writing an LLVM Pass â€” LLVM 5 documentation ã€‚å¦‚æœå¼€å¯äº† bitcode è‹¹æœä¼šåšè¿›ä¸€æ­¥çš„ä¼˜åŒ–ï¼Œæœ‰æ–°çš„åç«¯æ¶æ„è¿˜æ˜¯å¯ä»¥ç”¨è¿™ä»½ä¼˜åŒ–è¿‡çš„ bitcode å»ç”Ÿæˆã€‚<br><img src="https://raw.githubusercontent.com/sthyuhao/BlogImgZone/master/5a24c4cd300e6bbc613fbf7ee678fc.jpg" alt=""></p>
<p><strong>ç”Ÿæˆç›®æ ‡æ–‡ä»¶ï¼ˆAssembleï¼‰</strong>ï¼šç”ŸæˆTargetç›¸å…³Object(Mach-o)<br><strong>é“¾æ¥ï¼ˆLinkï¼‰</strong>ï¼šç”Ÿæˆ Executable å¯æ‰§è¡Œæ–‡ä»¶</p>
<p>ç»è¿‡è¿™ä¸€æ­¥æ­¥ï¼Œæˆ‘ä»¬ç”¨å„ç§é«˜çº§è¯­è¨€ç¼–å†™çš„ä»£ç å°±è½¬æ¢æˆäº†æœºå™¨å¯ä»¥çœ‹æ‡‚å¯ä»¥æ‰§è¡Œçš„ç›®æ ‡ä»£ç äº†ã€‚</p>
<hr>
<p>ç¯å¢ƒæ­å»º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">cd /opt</div><div class="line">sudo mkdir llvm</div><div class="line">sudo chown `whoami` llvm</div><div class="line">cd llvm</div><div class="line">export LLVM_HOME=`pwd`</div><div class="line"></div><div class="line">git clone -b release_39 git@github.com:llvm-mirror/llvm.git llvm</div><div class="line">git clone -b release_39 git@github.com:llvm-mirror/clang.git llvm/tools/clang</div><div class="line">git clone -b release_39 git@github.com:llvm-mirror/clang-tools-extra.git llvm/tools/clang/tools/extra</div><div class="line">git clone -b release_39 git@github.com:llvm-mirror/compiler-rt.git llvm/projects/compiler-rt</div><div class="line"></div><div class="line">mkdir llvm_build</div><div class="line">cd llvm_build</div><div class="line">cmake ../llvm -DCMAKE_BUILD_TYPE:STRING=Release</div><div class="line">make -j`sysctl -n hw.logicalcpu`</div></pre></td></tr></table></figure>
<p>æ–‡ä»¶å¾ˆå¤šå¾ˆå¤§ï¼Œéœ€è¦ä¸‹è½½ä¸€æ®µæ—¶é—´</p>
<hr>
<h3 id="Clang-Static-Analyzeré™æ€ä»£ç åˆ†æ"><a href="#Clang-Static-Analyzeré™æ€ä»£ç åˆ†æ" class="headerlink" title="Clang Static Analyzeré™æ€ä»£ç åˆ†æ"></a>Clang Static Analyzeré™æ€ä»£ç åˆ†æ</h3><p>clang é™æ€åˆ†ææ˜¯é€šè¿‡å»ºç«‹åˆ†æå¼•æ“å’Œ checkers æ‰€ç»„æˆçš„æ¶æ„ï¼Œè¿™éƒ¨åˆ†åŠŸèƒ½å¯ä»¥é€šè¿‡ clang â€”analyze å‘½ä»¤æ–¹å¼è°ƒç”¨ã€‚</p>
<h4 id="å‘½ä»¤è¡Œæ‰§è¡Œ"><a href="#å‘½ä»¤è¡Œæ‰§è¡Œ" class="headerlink" title="å‘½ä»¤è¡Œæ‰§è¡Œ"></a>å‘½ä»¤è¡Œæ‰§è¡Œ</h4><p>é€šè¿‡<code>clang -cc1 -analyzer-checker-help</code>å¯ä»¥åˆ—å‡ºèƒ½è°ƒç”¨çš„ checkerï¼Œä½†è¿™äº›checkerå¹¶ä¸æ˜¯æ‰€æœ‰éƒ½æ˜¯é»˜è®¤å¼€å¯çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">è¿™é‡Œä½¿ç”¨ä¸€ä¸ªé»˜è®¤å…³é—­çš„checker-alpha.security.ArrayBoundV2ä½œä¸ºä¾‹å­è¿›è¡Œæ“ä½œ</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">$ clang -cc1 -analyzer-checker-help</div><div class="line"> alpha.core.BoolAssignment       Warn about assigning non-&#123;0,1&#125; values to Boolean variables</div><div class="line">  alpha.core.CastSize             Check when casting a malloced type T, whether the size is a multiple of the size of T</div><div class="line">  alpha.core.CastToStruct         Check for cast from non-struct pointer to struct pointer</div><div class="line">  alpha.core.FixedAddr            Check for assignment of a fixed address to a pointer</div><div class="line">  alpha.core.IdenticalExpr        Warn about unintended use of identical expressions in operators</div><div class="line">  alpha.core.PointerArithm        Check for pointer arithmetic on locations other than array elements</div><div class="line">  alpha.core.PointerSub           Check for pointer subtractions on two pointers pointing to different memory chunks</div><div class="line">  alpha.core.SizeofPtr            Warn about unintended use of sizeof() on pointer expressions</div><div class="line">  alpha.cplusplus.NewDeleteLeaks  Check for memory leaks. Traces memory managed by new/delete.</div><div class="line">  alpha.cplusplus.VirtualCall     Check virtual function calls during construction or destruction</div><div class="line">  ...</div><div class="line">  alpha.security.ArrayBound       Warn about buffer overflows (older checker)</div><div class="line">  alpha.security.ArrayBoundV2     Warn about buffer overflows (newer checker)</div><div class="line">  alpha.security.MallocOverflow   Check for overflows in the arguments to malloc()</div><div class="line">  alpha.security.ReturnPtrRange   Check for an out-of-bound pointer being returned to callers</div><div class="line">  ...</div><div class="line">  core.CallAndMessage             Check for logical errors for function calls and Objective-C message expressions (e.g., uninitialized arguments, null function pointers)</div><div class="line">  core.DivideZero                 Check for division by zero</div><div class="line">  core.DynamicTypePropagation     Generate dynamic type information</div><div class="line">  core.NonNullParamChecker        Check for null pointers passed as arguments to a function whose arguments are references or marked with the &apos;nonnull&apos; attribute</div><div class="line">  core.NullDereference            Check for dereferences of null pointers</div><div class="line">  core.StackAddressEscape         Check that addresses to stack memory do not escape the function</div><div class="line">  ...</div><div class="line">  unix.API                        Check calls to various UNIX/Posix functions</div><div class="line">  unix.Malloc                     Check for memory leaks, double free, and use-after-free problems. Traces memory managed by malloc()/free().</div><div class="line">  unix.MallocSizeof               Check for dubious malloc arguments involving sizeof</div><div class="line">  unix.MismatchedDeallocator      Check for mismatched deallocators.</div><div class="line">  unix.cstring.BadSizeArg         Check the size argument passed into C string functions for common erroneous patterns</div><div class="line">  unix.cstring.NullArg            Check for null pointers being passed as arguments to C string functions</div></pre></td></tr></table></figure>
<p>å¯ä»¥ä½¿ç”¨ -enable-checker å’Œ -disable-checker å¼€å¯å’Œç¦ç”¨å…·ä½“çš„ checker æˆ–è€… æŸç§ç±»åˆ«çš„ checkerã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ scan-build -enable-checker alpha.security.ArrayBoundV2 ... # å¯ç”¨æ•°ç»„è¾¹ç•Œæ£€æŸ¥</div></pre></td></tr></table></figure>
<p>å½“ç„¶ï¼Œä½¿ç”¨<code>scan-build</code>å¯ç”¨çš„<code>checker</code>åªé€‚ç”¨äºä½¿ç”¨<code>scan-build</code>ç”Ÿæˆçš„htmlæŠ¥å‘Šã€‚<br><code>scan-build</code>åœ¨ç¼–è¯‘å®‰è£… llvm/clang ä¹‹åå¯ä»¥åœ¨<code>/llvm/tools/clang/tools/scan-build</code>ç›®å½•ä¸‹æ‰¾åˆ°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//å…è®¸æœªè¢«é»˜è®¤å…è®¸çš„checkå¹¶è¿›è¡Œä»£ç åˆ†æå¹¶å°†è¾“å‡ºç»“æœè¾“å‡ºè‡³ç½‘é¡µ</div><div class="line">./scan-build  -enable-checker alpha.security.ArrayBoundV2 --use-analyzer=/opt/llvm/llvm_build/bin -V xcodebuild  -project /Users/yuhao/TestClang/TestClang.xcodeproj -sdk iphonesimulator10.3</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬åœ¨TestClang.xcodeprojçš„main.mæ–‡ä»¶ä¸­æ’å…¥ä¸€æ®µ<strong>æ•°ç»„è¶Šç•Œ</strong>çš„ä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">int main()&#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        int a[2];</div><div class="line">        int i;</div><div class="line">        for (i = 0; i &lt; 3; i++)&#123;</div><div class="line">            a[i] = 0;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åæ‰§è¡Œä¸Šé¢çš„å‘½ä»¤ï¼Œä¼šå¯¼å‡ºè¿™æ ·çš„ä¸€ä¸ªç•Œé¢<br><img src="https://raw.githubusercontent.com/sthyuhao/BlogImgZone/master/aa1371b1bc6294c6670c06405d21af.jpg" alt=""></p>
<p>æŸ¥çœ‹æŠ¥è¡¨<br><img src="https://raw.githubusercontent.com/sthyuhao/BlogImgZone/master/dd6c434ef2591422dd73a921127933.jpg" alt=""></p>
<p>æŠ¥è¡¨ä¸­æç¤ºäº†è¯¥ä»£ç æœ‰æ•°ç»„è¶Šç•Œçš„é—®é¢˜ã€‚</p>
<h4 id="Xcodeæ‰§è¡Œ"><a href="#Xcodeæ‰§è¡Œ" class="headerlink" title="Xcodeæ‰§è¡Œ"></a>Xcodeæ‰§è¡Œ</h4><p>Xcodeæœ¬èº«å·²ç»è‡ªå¸¦äº†é™æ€æ£€æµ‹çš„åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡Product-Analyzeæ¥æ‰§è¡Œé™æ€æ£€æµ‹ï¼Œè¿™ä¹Ÿåªæ˜¯ç”¨è‡ªå¸¦çš„clangå»æ‰§è¡Œï¼Œå¦‚æœæƒ³ç”¨å…¶ä»–çš„ç‰ˆæœ¬ï¼Œæ¯”å¦‚è‡ªå·±ç¼–è¯‘clangï¼Œå°±éœ€è¦é€šè¿‡å‘½ä»¤æ¥è®¾ç½®ã€‚<br><img src="https://raw.githubusercontent.com/sthyuhao/BlogImgZone/master/04cbdacc0319f3038d048b3a8d4154.jpg" alt=""></p>
<p>åœ¨Xcodeçš„Producté€‰é¡¹å¡ä¸‹æœ‰Analyzeçš„é€‰é¡¹ï¼ŒXcodeä¸­é»˜è®¤æä¾›äº†ä¸€äº›checkersã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Usage: set-xcode-analyzer [options]</div><div class="line"></div><div class="line">Options:</div><div class="line">  -h, --help            show this help message and exit</div><div class="line">  --use-checker-build=PATH</div><div class="line">                        Use the Clang located at the provided absolute path,</div><div class="line">                        e.g. /Users/foo/checker-1</div><div class="line">  --use-xcode-clang     Use the Clang bundled with Xcode</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæœ‰2ä¸ªé€‰é¡¹ï¼Œ</p>
<p><code>--use-checker-build</code>ï¼šç”¨äºå°†xcodeçš„clangç‰ˆæœ¬åˆ‡æ¢æˆè®¾å®šçš„ç‰ˆæœ¬<br><code>--use-xcode-clang</code>ï¼šç”¨äºå°†xcodeçš„clangç‰ˆæœ¬åˆ‡æ¢å›å»</p>
<p>æ³¨ï¼šåœ¨æ‰§è¡Œä¸Šé¢å‘½ä»¤çš„æ—¶å€™ï¼Œéœ€è¦é€€å‡ºxcodeæ‰§è¡Œï¼›ä¸”éœ€è¦ç”¨sudoçš„æ–¹å¼è¿è¡Œã€‚</p>
<p>ä¾ç„¶ä½¿ç”¨ä¸Šé¢çš„projectæ–‡ä»¶ï¼Œåœ¨Build Settingsæ·»åŠ å‚æ•°ï¼Œå¦‚å›¾<img src="https://raw.githubusercontent.com/sthyuhao/BlogImgZone/master/34cf8b8a5732703934475d751b1091.jpg" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-Xanalyzer -analyzer-checker=alpha.security.ArrayBoundV2</div></pre></td></tr></table></figure>
<p>ç„¶åcmd+shift+b<br><img src="https://raw.githubusercontent.com/sthyuhao/BlogImgZone/master/b7736892a027cb392fbf49be64b5f1.jpg" alt=""></p>
<p>åœ¨Xcodeä¸­ä¹Ÿå‡ºç°äº†å’ŒæŠ¥è¡¨åŒæ ·çš„æç¤ºã€‚<br>å…³äºcheckerçš„å¼€å‘å¯ä»¥çœ‹<a href="http://clang-analyzer.llvm.org.cn/checker_dev_manual.html" target="_blank" rel="external">è¿™é‡Œ</a>ã€‚</p>
<hr>
<h3 id="å…³äºARCï¼ˆAUTOMATIC-REFERENCE-COUNTINGï¼‰"><a href="#å…³äºARCï¼ˆAUTOMATIC-REFERENCE-COUNTINGï¼‰" class="headerlink" title="å…³äºARCï¼ˆAUTOMATIC REFERENCE COUNTINGï¼‰"></a>å…³äºARCï¼ˆAUTOMATIC REFERENCE COUNTINGï¼‰</h3><p>ARCæ˜¯ios5.0å¼•å…¥çš„æ–°ç‰¹æ€§ï¼Œå®Œå…¨æ¶ˆé™¤æ‰‹åŠ¨ç®¡ç†å†…å­˜çš„ç¹çï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åœ¨é€‚åˆçš„ä»£ç é‡Œé¢æ’å…¥é€‚å½“çš„retainï¼Œreleaseï¼Œautoreleaseçš„è¯­å¥ã€‚æˆ‘ä»¬ä¸è¦å†æ‹…å¿ƒå†…å­˜ç®¡ç†ï¼Œå› ä¸ºç¼–è¯‘å™¨å¸®æˆ‘ä»¬åšäº†è¿™ä¸€åˆ‡ã€‚<br>æˆ‘ä»¬éƒ½çŸ¥é“ARCçš„è§„åˆ™å°±æ˜¯åªè¦å¯¹è±¡æ²¡æœ‰å¼ºæŒ‡é’ˆå¼•ç”¨ï¼Œå°±ä¼šè¢«é‡Šæ”¾æ‰ã€‚é‚£ä¹ˆï¼Œè¯¥å¯¹è±¡æ˜¯ä»€ä¹ˆæ—¶å€™è¢«é‡Šæ”¾ï¼Œåˆæ˜¯è°æ“ä½œå»é‡Šæ”¾è¯¥å¯¹è±¡çš„ï¼Ÿ</p>
<p><strong>è‡ªåŠ¨æ·»åŠ release</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    id a;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç ä¸­æœ‰å¼ºå¼•ç”¨çš„å¯¹è±¡ï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤å°†ä»£ç ç¼–è¯‘æˆä¸­é—´è¯­è¨€ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -S -fobjc-arc -emit-llvm main.m -o main.ll</div></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">define i32 @main(i32, i8**) #0 &#123;</div><div class="line">  %3 = alloca i32, align 4</div><div class="line">  %4 = alloca i32, align 4</div><div class="line">  %5 = alloca i8**, align 8</div><div class="line">  %6 = alloca i8*, align 8</div><div class="line">  store i32 0, i32* %3, align 4</div><div class="line">  store i32 %0, i32* %4, align 4</div><div class="line">  store i8** %1, i8*** %5, align 8</div><div class="line">  store i8* null, i8** %6, align 8</div><div class="line">  store i32 0, i32* %3, align 4</div><div class="line">  call void @objc_storeStrong(i8** %6, i8* null) #1</div><div class="line">  %7 = load i32, i32* %3, align 4</div><div class="line">  ret i32 %7</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>allocaå‡½æ•°ç”³è¯·å†…å­˜åœ°å€ï¼Œè€Œstoreè¡¨ç¤ºå°†å€¼å­˜åˆ°æŒ‡å®šåœ°å€ã€‚ å‡½æ•°çš„æœ€åè°ƒç”¨äº†å‡½æ•°<code>objc_storeStrong</code>,æŸ¥è¯¢<a href="https://clang.llvm.org/docs/AutomaticReferenceCounting.html#purpose" target="_blank" rel="external">ARCæ–‡æ¡£</a>å¯ä»¥çŸ¥é“<code>objc_storeStrong</code>çš„å®ç°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">void objc_storeStrong(id *object, id value) &#123;</div><div class="line">  id oldValue = *object;</div><div class="line">  value = [value retain];</div><div class="line">  *object = value;</div><div class="line">  [oldValue release];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>call void @objc_storeStrong(i8** %6, i8* null)</code>å¯¹<code>null</code>è¿›è¡Œäº†<code>retain</code>ï¼Œå¯¹<code>a</code>è¿›è¡Œäº†<code>release</code>ã€‚<br>ç»¼ä¸Šï¼Œåœ¨<code>__strong</code>ç±»å‹çš„å˜é‡çš„ä½œç”¨åŸŸç»“æŸæ—¶ï¼Œè‡ªåŠ¨æ·»åŠ <code>release</code>å‡½æ•°è¿›è¡Œé‡Šæ”¾ã€‚</p>
<p><strong>è‡ªåŠ¨æ·»åŠ retain</strong><br>æŸ¥é˜…<a href="https://clang.llvm.org/docs/AutomaticReferenceCounting.html#purpose" target="_blank" rel="external">ARCæ–‡æ¡£</a>ï¼Œå‘ç°æœ‰<code>objc_retain</code>è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œé¡¾åæ€ä¹‰ï¼Œè¯¥å‡½æ•°å°±æ˜¯å°†å¯¹è±¡è¿›è¡Œ<code>retain</code>æ“ä½œã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">id objc_retainAutorelease(id value) &#123;</div><div class="line">  return objc_autorelease(objc_retain(value));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>objc_retainAutorelease(id value)</code>å½“<code>value</code>ä¸º<code>null</code>æˆ–æŒ‡é’ˆæŒ‡å‘æœ‰æ•ˆå¯¹è±¡,å¦‚æœ<code>value</code>ä¸º<code>null</code>ï¼Œåˆ™æ­¤è°ƒç”¨ä¸èµ·ä½œç”¨ã€‚å¦åˆ™ï¼Œå®ƒæ‰§è¡Œä¿ç•™æ“ä½œï¼Œç„¶åæ‰§è¡Œè‡ªåŠ¨é‡Šæ”¾æ“ä½œã€‚å³å¯¹ä¸€ä¸ªå˜é‡å…ˆè¿›è¡Œä¸€æ¬¡<code>retain</code>ï¼Œå†æ·»è¿›è¡Œ<code>autorelease</code>ã€‚</p>
<p><strong>weakçš„å®ç°</strong><br><code>runtime</code>æ˜¯å¦‚ä½•å®ç°åœ¨<code>weak</code>ä¿®é¥°çš„å˜é‡çš„å¯¹è±¡åœ¨è¢«é”€æ¯æ—¶è‡ªåŠ¨ç½®ä¸º<code>nil</code>çš„å‘¢ï¼Ÿä¸€ä¸ªæ™®éçš„è§£é‡Šæ˜¯:<code>runtime</code>å¯¹æ³¨å†Œçš„ç±»ä¼šè¿›è¡Œå¸ƒå±€ï¼Œå¯¹äº<code>weak</code>ä¿®é¥°çš„å¯¹è±¡ä¼šæ”¾å…¥ä¸€ä¸ª<code>hash</code>è¡¨ä¸­ã€‚ç”¨<code>weak</code>æŒ‡å‘çš„å¯¹è±¡å†…å­˜åœ°å€ä½œä¸º<code>key</code>ï¼Œå½“æ­¤å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º<code>0</code>çš„æ—¶å€™ä¼š<code>dealloc</code>ï¼Œå‡å¦‚<code>weak</code>æŒ‡å‘çš„å¯¹è±¡å†…å­˜åœ°å€æ˜¯<code>a</code>ï¼Œé‚£ä¹ˆå°±ä¼šä»¥<code>a</code>ä¸ºé”®åœ¨è¿™ä¸ª<code>weak</code>è¡¨ä¸­æœç´¢ï¼Œæ‰¾åˆ°æ‰€æœ‰ä»¥<code>a</code>ä¸ºé”®çš„<code>weak</code>å¯¹è±¡ï¼Œä»è€Œè®¾ç½®ä¸º<code>nil</code>ã€‚</p>
<p><code>weak</code>æŒ‡é’ˆçš„å®ç°å€ŸåŠ©<code>Objective-C</code>çš„è¿è¡Œæ—¶ç‰¹æ€§ï¼Œ<code>runtime</code>é€šè¿‡ <code>objc_storeWeak</code>, <code>objc_destroyWeak</code>å’Œ <code>objc_moveWeak</code>ç­‰æ–¹æ³•ï¼Œç›´æ¥ä¿®æ”¹<code>__weak</code>å¯¹è±¡ï¼Œæ¥å®ç°å¼±å¼•ç”¨ã€‚</p>
<p><code>objc_storeWeak</code>å‡½æ•°ï¼Œå°†é™„æœ‰<code>__weak</code>æ ‡è¯†ç¬¦çš„å˜é‡çš„åœ°å€æ³¨å†Œåˆ°<code>weak</code>è¡¨ä¸­ï¼Œ<code>weak</code>è¡¨æ˜¯ä¸€ä»½ä¸å¼•ç”¨è®¡æ•°è¡¨ç›¸ä¼¼çš„æ•£åˆ—è¡¨ã€‚</p>
<p>è€Œè¯¥å˜é‡ä¼šåœ¨é‡Šæ”¾çš„è¿‡ç¨‹ä¸­æ¸…ç†<code>weak</code>è¡¨ä¸­çš„å¼•ç”¨ï¼Œå˜é‡é‡Šæ”¾è°ƒç”¨ä»¥ä¸‹å‡½æ•°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">dealloc</div><div class="line">_objec_rootDealloc</div><div class="line">object_dispose</div><div class="line">objc_destructInstance</div><div class="line">objc_clear_deallocating</div></pre></td></tr></table></figure>
<p>åœ¨æœ€åçš„<code>objc_clear_deallocating</code>å‡½æ•°ä¸­ï¼Œä»<code>weak</code>è¡¨ä¸­æ‰¾åˆ°å¼±å¼•ç”¨æŒ‡é’ˆçš„åœ°å€ï¼Œç„¶åç½®ä¸º<code>nil</code>,å¹¶ä»<code>weak</code>è¡¨åˆ é™¤è®°å½•ã€‚</p>
<p>å…³äºARCæ›´å¤šå®ç°è¯·å‚é˜…<a href="http://luoxianming.cn/2017/05/06/arc/" target="_blank" rel="external">æ¢ç©¶ARC</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-05-15</span><i class="fa fa-comment-o"></i><a href="/2017/05/15/LLVMä¸Clangçš„ä¸€äº›äº‹å„¿/#comments">ComentÃ¡rios</a><i class="fa fa-tag"></i><a class="tag" href="/categories/LLVM/" title="LLVM">LLVM </a><a class="tag" href="/tags/LLVM/" title="LLVM">LLVM </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2017/05/15/LLVMä¸Clangçš„ä¸€äº›äº‹å„¿/,ä½™ç”Ÿ,LLVMä¸Clangçš„ä¸€äº›äº‹å„¿,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/08/03/Xcodeé›†æˆO-LLVM/" title="Xcodeé›†æˆO-LLVM">Post Anterior</a></li></ul></div><a id="comments"></a><div class="ds-thread" data-thread-key="2017/05/15/LLVMä¸Clangçš„ä¸€äº›äº‹å„¿/" data-title="LLVMä¸Clangçš„ä¸€äº›äº‹å„¿" data-url="http://yoursite.com/2017/05/15/LLVMä¸Clangçš„ä¸€äº›äº‹å„¿/" data-author-key="1"></div><script>var duoshuoQuery = {short_name:"ğŸŸçš„æˆé•¿ä¹‹è·¯"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>